<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{% if lang == 'en' %}Add Multiple Exercises{% else %}Ajouter plusieurs exercices{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --secondary-dark: #1a252f;
      --success: #2ecc71;
      --warning: #f39c12;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .lang-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .form-box {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .form-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 25px 30px;
      text-align: center;
    }

    .form-header h2 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .form-body {
      padding: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
    }

    .required::after {
      content: " *";
      color: #e74c3c;
    }

    textarea, input, select, math-field {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }

    textarea:focus, input:focus, select:focus, math-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      white-space: pre-wrap;
    }

    math-field {
      min-height: 3.5em;
      margin-top: 5px;
    }

    .math-editor-container {
      position: relative;
      margin-bottom: 10px;
    }

    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 15px rgba(46, 204, 113, 0.4);
    }

    .back-link {
      text-align: center;
      margin-top: 25px;
    }

    .back-link a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--secondary);
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .form-section-title {
      font-size: 1.3rem;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Styles pour les exercices multiples */
    .exercises-container {
      margin-top: 20px;
    }

    .exercise-card {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      position: relative;
      transition: var(--transition);
    }

    .exercise-card:hover {
      border-color: var(--primary);
      box-shadow: var(--box-shadow);
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #dee2e6;
    }

    .exercise-number {
      background: var(--primary);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .remove-exercise {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: var(--transition);
    }

    .remove-exercise:hover {
      background: #c0392b;
    }

    .add-exercise-btn {
      background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin: 20px 0;
    }

    .add-exercise-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
    }

    .toggle-optional {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 10px 0;
      padding: 5px;
    }

    .optional-fields {
      display: none;
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px dashed var(--light-gray);
    }

    .optional-fields.show {
      display: block;
    }

    .counter-badge {
      background: var(--warning);
      color: white;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-left: 10px;
    }

    .language-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .math-insert-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }

    .math-insert-btn:hover {
      background-color: var(--primary-dark);
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: var(--light-gray);
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-label:hover {
      background: #dfe6e9;
      border-color: var(--primary);
    }

    .image-preview {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 2px solid var(--light-gray);
      display: none;
    }

    .image-preview img {
      max-width: 300px;
      max-height: 200px;
      border-radius: 8px;
      display: block;
      margin-bottom: 10px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: var(--box-shadow);
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.4s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: #e74c3c;
    }

    .batch-options {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .batch-option-btn {
      background: var(--light-gray);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .batch-option-btn.active {
      background: #e3f2fd;
      border-color: var(--primary);
      color: var(--primary);
    }

    .batch-option-btn:hover:not(.active) {
      background: #e9ecef;
    }

    .optional-badge {
      background: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .required-badge {
      background: #e74c3c;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .instruction-text {
      color: var(--gray);
      font-size: 0.9rem;
      margin-top: 5px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .form-body {
        padding: 20px;
      }

      .batch-options {
        flex-direction: column;
      }
    }
  </style>
  <script defer src="https://unpkg.com/mathlive"></script>
</head>
<body>
  <div class="container">
    <!-- Header avec s√©lecteur de langue -->
    <div class="header">
      <div class="lang-selector">
        <label for="lang">üåç</label>
        <form method="POST" action="/changer-langue" id="langForm">
          <select name="lang" id="lang" onchange="document.getElementById('langForm').submit()">
            <option value="fr" {% if lang == 'fr' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
            <option value="en" {% if lang == 'en' %}selected{% endif %}>üá¨üáß English</option>
          </select>
          <input type="hidden" name="redirect_page" value="ajouter_exercice">
        </form>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="form-box">
      <div class="form-header">
        <h2><i class="fas fa-layer-group"></i> {% if lang == 'en' %}Add Multiple Exercises{% else %}Ajouter plusieurs exercices{% endif %}</h2>
        <p>{% if lang == 'en' %}Create multiple exercises at once for the same lesson{% else %}Cr√©ez plusieurs exercices en une seule fois pour la m√™me le√ßon{% endif %}</p>
      </div>

      <div class="form-body">
        <form method="POST" enctype="multipart/form-data" id="exerciseForm">
          <!-- Section Cat√©gorisation (commune √† tous les exercices) -->
          <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-folder-open"></i> {% if lang == 'en' %}Common Settings{% else %}Param√®tres communs{% endif %}</h3>

            <div class="form-grid">
              <div class="form-group">
                <label for="niveau" class="required">{% if lang == 'en' %}Level{% else %}Niveau{% endif %} <span class="required-badge">Requis</span>:</label>
                <select name="niveau_id" id="niveau" required>
                  <option value="">{% if lang == 'en' %}-- Choose level --{% else %}-- Choisir un niveau --{% endif %}</option>
                  {% for niveau in niveaux %}
                    <option value="{{ niveau.id }}">{{ niveau.nom_en if lang == 'en' and niveau.nom_en else niveau.nom }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label for="matiere" class="required">{% if lang == 'en' %}Subject{% else %}Mati√®re{% endif %} <span class="required-badge">Requis</span>:</label>
                <select id="matiere" name="matiere_id" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose subject --{% else %}-- Choisir une mati√®re --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="unite" class="required">{% if lang == 'en' %}Unit{% else %}Unit√©{% endif %} <span class="required-badge">Requis</span>:</label>
                <select id="unite" name="unite_id" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose unit --{% else %}-- Choisir une unit√© --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="lecon" class="required">{% if lang == 'en' %}Associated Lesson{% else %}Le√ßon associ√©e{% endif %} <span class="required-badge">Requis</span>:</label>
                <select name="lecon_id" id="lecon" required disabled>
                  <option value="">{% if lang == 'en' %}-- Choose lesson --{% else %}-- Choisir une le√ßon --{% endif %}</option>
                </select>
              </div>

              <div class="form-group">
                <label for="temps_commun">{% if lang == 'en' %}Time per exercise (seconds){% else %}Temps par exercice (secondes){% endif %} <span class="optional-badge">Facultatif</span>:</label>
                <input type="number" name="temps_commun" id="temps_commun" value="60" min="10" max="600">
                <div class="instruction-text">{% if lang == 'en' %}Default: 60 seconds. Can be overridden for each exercise.{% else %}Par d√©faut : 60 secondes. Peut √™tre modifi√© pour chaque exercice.{% endif %}</div>
              </div>
            </div>
          </div>

          <!-- Section des exercices multiples -->
          <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 class="form-section-title"><i class="fas fa-tasks"></i> {% if lang == 'en' %}Exercises{% else %}Exercices{% endif %} <span class="counter-badge" id="exerciseCounter">1</span></h3>

              <!-- Options de lot -->
              <div class="batch-options">
                <button type="button" class="batch-option-btn" onclick="applyToAll('temps')">
                  <i class="fas fa-clock"></i> {% if lang == 'en' %}Apply time to all{% else %}Appliquer le temps √† tous{% endif %}
                </button>
              </div>
            </div>

            <div class="exercises-container" id="exercisesContainer">
              <!-- Premier exercice -->
              <div class="exercise-card" data-exercise="1">
                <div class="exercise-header">
                  <div class="exercise-number">1</div>
                  <button type="button" class="remove-exercise" onclick="removeExercise(1)" style="display: none;">
                    <i class="fas fa-trash"></i> {% if lang == 'en' %}Remove{% else %}Supprimer{% endif %}
                  </button>
                </div>

                <!-- Onglets pour les langues -->
                <div class="language-tabs">
                  <div class="tab active" data-tab="french-1">üá´üá∑ Fran√ßais</div>
                  <div class="tab" data-tab="english-1">üá¨üáß English</div>
                </div>

                <!-- Contenu fran√ßais -->
                <div class="tab-content active" id="french-content-1">
                  <div class="form-group">
                    <label for="question_fr_1" class="required">Question <span class="required-badge">Requis</span>:</label>
                    <textarea name="exercises[1][question_fr]" id="question_fr_1" placeholder="Saisissez la question en fran√ßais" required></textarea>
                    <div class="math-editor-container">
                      <math-field id="question_fr_field_1" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                    </div>
                    <button type="button" class="math-insert-btn" onclick="insererLatex('question_fr_1')">
                      <i class="fas fa-plus"></i> Ins√©rer une formule
                    </button>
                  </div>

                  <!-- Tous les autres champs sont facultatifs -->
                  <button type="button" class="toggle-optional" onclick="toggleOptionalFields(1, this)">
                    <i class="fas fa-plus-circle"></i>
                    {% if lang == 'en' %}Show additional fields (optional){% else %}Afficher les champs suppl√©mentaires (facultatifs){% endif %}
                  </button>

                  <div class="optional-fields" id="optional-fields-1">
                    <div class="form-group">
                      <label for="reponse_fr_1">R√©ponse <span class="optional-badge">Facultatif</span>:</label>
                      <textarea name="exercises[1][reponse_fr]" id="reponse_fr_1" placeholder="Saisissez la r√©ponse correcte (optionnel)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="reponse_fr_field_1" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_fr_1')">
                        <i class="fas fa-plus"></i> Ins√©rer une formule
                      </button>
                    </div>

                    <div class="form-group">
                      <label for="explication_fr_1">Explication <span class="optional-badge">Facultatif</span>:</label>
                      <textarea name="exercises[1][explication_fr]" id="explication_fr_1" placeholder="Expliquez la solution ou le raisonnement (optionnel)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="explication_fr_field_1" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('explication_fr_1')">
                        <i class="fas fa-plus"></i> Ins√©rer une formule
                      </button>
                    </div>

                    <div class="form-group">
                      <label for="options_fr_1">Options (s√©par√©es par des virgules) <span class="optional-badge">Facultatif</span>:</label>
                      <textarea name="exercises[1][options_fr]" id="options_fr_1" placeholder="Option 1, Option 2, Option 3, ... (optionnel)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="options_fr_field_1" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('options_fr_1')">
                        <i class="fas fa-plus"></i> Ins√©rer une formule
                      </button>
                    </div>

                    <!-- Image pour cet exercice -->
                    <div class="form-group">
                      <label for="image_exercice_1">
                        <i class="fas fa-image"></i>
                        {% if lang == 'en' %}Upload image (optional){% else %}T√©l√©charger une image (facultative){% endif %} <span class="optional-badge">Facultatif</span>
                      </label>
                      <div class="file-upload">
                        <input type="file" name="image_exercice_1" id="image_exercice_1" accept="image/*" class="exercise-image">
                        <label for="image_exercice_1" class="file-upload-label">
                          <i class="fas fa-cloud-upload-alt"></i>
                          <span class="file-name">{% if lang == 'en' %}Choose an image...{% else %}Choisir une image...{% endif %}</span>
                        </label>
                      </div>
                      <div class="image-preview" id="imagePreview-1">
                        <strong>{% if lang == 'en' %}Preview:{% else %}Aper√ßu :{% endif %}</strong>
                        <img class="previewImage" src="#" alt="Preview">
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="temps_1">{% if lang == 'en' %}Time (seconds){% else %}Temps (secondes){% endif %} <span class="optional-badge">Facultatif</span>:</label>
                      <input type="number" name="exercises[1][temps]" id="temps_1" value="60" min="10" max="600" class="exercise-time">
                      <div class="instruction-text">{% if lang == 'en' %}Overrides common time. Default: 60 seconds.{% else %}Remplace le temps commun. Par d√©faut : 60 secondes.{% endif %}</div>
                    </div>
                  </div>
                </div>

                <!-- Contenu anglais -->
                <div class="tab-content" id="english-content-1">
                  <div class="form-group">
                    <label for="question_en_1" class="required">Question <span class="required-badge">Required</span>:</label>
                    <textarea name="exercises[1][question_en]" id="question_en_1" placeholder="Enter the question in English" required></textarea>
                    <div class="math-editor-container">
                      <math-field id="question_en_field_1" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
                    </div>
                    <button type="button" class="math-insert-btn" onclick="insererLatex('question_en_1')">
                      <i class="fas fa-plus"></i> Insert formula
                    </button>
                  </div>

                  <!-- Tous les autres champs sont facultatifs -->
                  <div class="optional-fields">
                    <div class="form-group">
                      <label for="reponse_en_1">Answer <span class="optional-badge">Optional</span>:</label>
                      <textarea name="exercises[1][reponse_en]" id="reponse_en_1" placeholder="Enter the correct answer (optional)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="reponse_en_field_1" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_en_1')">
                        <i class="fas fa-plus"></i> Insert formula
                      </button>
                    </div>

                    <div class="form-group">
                      <label for="explication_en_1">Explanation <span class="optional-badge">Optional</span>:</label>
                      <textarea name="exercises[1][explication_en]" id="explication_en_1" placeholder="Explain the solution or reasoning (optional)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="explication_en_field_1" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('explication_en_1')">
                        <i class="fas fa-plus"></i> Insert formula
                      </button>
                    </div>

                    <div class="form-group">
                      <label for="options_en_1">Options (comma-separated) <span class="optional-badge">Optional</span>:</label>
                      <textarea name="exercises[1][options_en]" id="options_en_1" placeholder="Option 1, Option 2, Option 3, ... (optional)"></textarea>
                      <div class="math-editor-container">
                        <math-field id="options_en_field_1" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
                      </div>
                      <button type="button" class="math-insert-btn" onclick="insererLatex('options_en_1')">
                        <i class="fas fa-plus"></i> Insert formula
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Fin du premier exercice -->
            </div>

            <button type="button" class="add-exercise-btn" onclick="addExercise()">
              <i class="fas fa-plus"></i> {% if lang == 'en' %}Add Another Exercise{% else %}Ajouter un autre exercice{% endif %}
            </button>
          </div>

          <button type="submit" class="submit-button" id="submitBtn">
            <i class="fas fa-save"></i> {% if lang == 'en' %}Save All Exercises{% else %}Enregistrer tous les exercices{% endif %}
          </button>
        </form>
      </div>
    </div>

    <div class="back-link">
      <a href="{{ dashboard_url }}">
        <i class="fas fa-home"></i> {% if lang == 'en' %}Back to Dashboard{% else %}Retour au tableau de bord{% endif %}
      </a>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // Variables globales
    let exerciseCount = 1;
    const langJs = "{{ lang }}";
    const notification = document.getElementById("notification");
    const submitBtn = document.getElementById("submitBtn");

    // FONCTION CORRIG√âE : R√©indexation OBLIGATOIRE
    function reindexExercises() {
      const cards = document.querySelectorAll(".exercise-card");
      cards.forEach((card, index) => {
        const newIndex = index + 1;
        card.setAttribute("data-exercise", newIndex);
        const exerciseNumber = card.querySelector(".exercise-number");
        if (exerciseNumber) exerciseNumber.textContent = newIndex;

        // Mettre √† jour tous les champs avec name="exercises[...]"
        card.querySelectorAll("[name^='exercises[']").forEach(input => {
          const oldName = input.name;
          const newName = oldName.replace(/exercises\[\d+\]/, `exercises[${newIndex}]`);
          input.name = newName;
          if (input.id) input.id = input.id.replace(/\d+$/, newIndex);
        });

        // Mettre √† jour le champ d'image
        const fileInput = card.querySelector("input[type='file']");
        if (fileInput) {
          fileInput.name = `image_exercice_${newIndex}`;
          fileInput.id = `image_exercice_${newIndex}`;
        }

        // Mettre √† jour les onglets de langue
        const tabs = card.querySelectorAll(".tab");
        tabs.forEach(tab => {
          const oldTab = tab.getAttribute("data-tab");
          if (oldTab) {
            const newTab = oldTab.replace(/\d+$/, newIndex);
            tab.setAttribute("data-tab", newTab);
          }
        });

        // Mettre √† jour les contenus des onglets
        const tabContents = card.querySelectorAll(".tab-content");
        tabContents.forEach(content => {
          const oldId = content.id;
          if (oldId) {
            const newId = oldId.replace(/\d+$/, newIndex);
            content.id = newId;
          }
        });

        // Mettre √† jour les champs math√©matiques
        const mathFields = card.querySelectorAll("math-field");
        mathFields.forEach(mathField => {
          const oldId = mathField.id;
          if (oldId) {
            const newId = oldId.replace(/\d+$/, newIndex);
            mathField.id = newId;
          }
        });

        // Mettre √† jour les aper√ßus d'image
        const imagePreview = card.querySelector(".image-preview");
        if (imagePreview) imagePreview.id = `imagePreview-${newIndex}`;

        // Mettre √† jour les boutons onclick
        const buttons = card.querySelectorAll("button");
        buttons.forEach(button => {
          const onclick = button.getAttribute("onclick");
          if (onclick) {
            const newOnclick = onclick.replace(/\d+/g, newIndex);
            button.setAttribute("onclick", newOnclick);
          }
        });
      });

      // Mettre √† jour le compteur
      document.getElementById("exerciseCounter").textContent = cards.length;
      exerciseCount = cards.length;
    }

    // Donn√©es du template pour les nouveaux exercices
    const exerciseTemplate = `
      <div class="exercise-card" data-exercise="{{index}}">
        <div class="exercise-header">
          <div class="exercise-number">{{index}}</div>
          <button type="button" class="remove-exercise" onclick="removeExercise({{index}})">
            <i class="fas fa-trash"></i> ${langJs === 'en' ? 'Remove' : 'Supprimer'}
          </button>
        </div>

        <div class="language-tabs">
          <div class="tab active" data-tab="french-{{index}}">üá´üá∑ Fran√ßais</div>
          <div class="tab" data-tab="english-{{index}}">üá¨üáß English</div>
        </div>

        <div class="tab-content active" id="french-content-{{index}}">
          <div class="form-group">
            <label for="question_fr_{{index}}" class="required">Question <span class="required-badge">Requis</span>:</label>
            <textarea name="exercises[{{index}}][question_fr]" id="question_fr_{{index}}" placeholder="Saisissez la question en fran√ßais" required></textarea>
            <div class="math-editor-container">
              <math-field id="question_fr_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
            </div>
            <button type="button" class="math-insert-btn" onclick="insererLatex('question_fr_{{index}}')">
              <i class="fas fa-plus"></i> Ins√©rer une formule
            </button>
          </div>

          <button type="button" class="toggle-optional" onclick="toggleOptionalFields({{index}}, this)">
            <i class="fas fa-plus-circle"></i>
            ${langJs === 'en' ? 'Show additional fields (optional)' : 'Afficher les champs suppl√©mentaires (facultatifs)'}
          </button>

          <div class="optional-fields" id="optional-fields-{{index}}">
            <div class="form-group">
              <label for="reponse_fr_{{index}}">R√©ponse <span class="optional-badge">Facultatif</span>:</label>
              <textarea name="exercises[{{index}}][reponse_fr]" id="reponse_fr_{{index}}" placeholder="Saisissez la r√©ponse correcte (optionnel)"></textarea>
              <div class="math-editor-container">
                <math-field id="reponse_fr_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_fr_{{index}}')">
                <i class="fas fa-plus"></i> Ins√©rer une formule
              </button>
            </div>

            <div class="form-group">
              <label for="explication_fr_{{index}}">Explication <span class="optional-badge">Facultatif</span>:</label>
              <textarea name="exercises[{{index}}][explication_fr]" id="explication_fr_{{index}}" placeholder="Expliquez la solution ou le raisonnement (optionnel)"></textarea>
              <div class="math-editor-container">
                <math-field id="explication_fr_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('explication_fr_{{index}}')">
                <i class="fas fa-plus"></i> Ins√©rer une formule
              </button>
            </div>

            <div class="form-group">
              <label for="options_fr_{{index}}">Options (s√©par√©es par des virgules) <span class="optional-badge">Facultatif</span>:</label>
              <textarea name="exercises[{{index}}][options_fr]" id="options_fr_{{index}}" placeholder="Option 1, Option 2, Option 3, ... (optionnel)"></textarea>
              <div class="math-editor-container">
                <math-field id="options_fr_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="√âcrivez des formules math√©matiques ici"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('options_fr_{{index}}')">
                <i class="fas fa-plus"></i> Ins√©rer une formule
              </button>
            </div>

            <div class="form-group">
              <label for="image_exercice_{{index}}">
                <i class="fas fa-image"></i>
                ${langJs === 'en' ? 'Upload image (optional)' : 'T√©l√©charger une image (facultative)'} <span class="optional-badge">Facultatif</span>
              </label>
              <div class="file-upload">
                <input type="file" name="image_exercice_{{index}}" id="image_exercice_{{index}}" accept="image/*" class="exercise-image" onchange="previewImage(this, {{index}})">
                <label for="image_exercice_{{index}}" class="file-upload-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span class="file-name">${langJs === 'en' ? 'Choose an image...' : 'Choisir une image...'}</span>
                </label>
              </div>
              <div class="image-preview" id="imagePreview-{{index}}">
                <strong>${langJs === 'en' ? 'Preview:' : 'Aper√ßu :'}</strong>
                <img class="previewImage" src="#" alt="Preview">
              </div>
            </div>

            <div class="form-group">
              <label for="temps_{{index}}">${langJs === 'en' ? 'Time (seconds)' : 'Temps (secondes)'} <span class="optional-badge">Facultatif</span>:</label>
              <input type="number" name="exercises[{{index}}][temps]" id="temps_{{index}}" value="60" min="10" max="600" class="exercise-time">
              <div class="instruction-text">${langJs === 'en' ? 'Overrides common time. Default: 60 seconds.' : 'Remplace le temps commun. Par d√©faut : 60 secondes.'}</div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="english-content-{{index}}">
          <div class="form-group">
            <label for="question_en_{{index}}" class="required">Question <span class="required-badge">Required</span>:</label>
            <textarea name="exercises[{{index}}][question_en]" id="question_en_{{index}}" placeholder="Enter the question in English" required></textarea>
            <div class="math-editor-container">
              <math-field id="question_en_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
            </div>
            <button type="button" class="math-insert-btn" onclick="insererLatex('question_en_{{index}}')">
              <i class="fas fa-plus"></i> Insert formula
            </button>
          </div>

          <div class="optional-fields">
            <div class="form-group">
              <label for="reponse_en_{{index}}">Answer <span class="optional-badge">Optional</span>:</label>
              <textarea name="exercises[{{index}}][reponse_en]" id="reponse_en_{{index}}" placeholder="Enter the correct answer (optional)"></textarea>
              <div class="math-editor-container">
                <math-field id="reponse_en_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('reponse_en_{{index}}')">
                <i class="fas fa-plus"></i> Insert formula
              </button>
            </div>

            <div class="form-group">
              <label for="explication_en_{{index}}">Explanation <span class="optional-badge">Optional</span>:</label>
              <textarea name="exercises[{{index}}][explication_en]" id="explication_en_{{index}}" placeholder="Explain the solution or reasoning (optional)"></textarea>
              <div class="math-editor-container">
                <math-field id="explication_en_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('explication_en_{{index}}')">
                <i class="fas fa-plus"></i> Insert formula
              </button>
            </div>

            <div class="form-group">
              <label for="options_en_{{index}}">Options (comma-separated) <span class="optional-badge">Optional</span>:</label>
              <textarea name="exercises[{{index}}][options_en]" id="options_en_{{index}}" placeholder="Option 1, Option 2, Option 3, ... (optional)"></textarea>
              <div class="math-editor-container">
                <math-field id="options_en_field_{{index}}" virtual-keyboard-mode="onfocus" placeholder="Write math formulas here"></math-field>
              </div>
              <button type="button" class="math-insert-btn" onclick="insererLatex('options_en_{{index}}')">
                <i class="fas fa-plus"></i> Insert formula
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Initialisation
    document.addEventListener("DOMContentLoaded", () => {
      initLanguageTabs();
      initMathFields();
      setupNavigation();
      initFileUploads();

      // Charger la hi√©rarchie p√©dagogique
      const niveau = document.getElementById("niveau");
      const matiere = document.getElementById("matiere");
      const unite = document.getElementById("unite");
      const lecon = document.getElementById("lecon");

      if (niveau) {
        niveau.addEventListener("change", async function() {
          await loadMatieres(this.value, matiere);
        });
      }

      if (matiere) {
        matiere.addEventListener("change", async function() {
          await loadUnites(this.value, unite);
        });
      }

      if (unite) {
        unite.addEventListener("change", async function() {
          await loadLecons(this.value, lecon);
        });
      }
    });

    // FONCTION CORRIG√âE POUR LES ONGLETS DE LANGUE
    function initLanguageTabs() {
      document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('tab')) {
          const tab = e.target;
          const exercise = tab.closest('.exercise-card');
          if (!exercise) return;

          const tabId = tab.getAttribute('data-tab');
          const allTabsInExercise = exercise.querySelectorAll('.tab');
          allTabsInExercise.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const allContentsInExercise = exercise.querySelectorAll('.tab-content');
          allContentsInExercise.forEach(content => content.classList.remove('active'));

          const contentId = tabId.replace('-', '-content-');
          const targetContent = exercise.querySelector(`#${contentId}`);
          if (targetContent) targetContent.classList.add('active');
        }
      });
    }

    // FONCTION CORRIG√âE POUR AJOUTER UN EXERCICE
    function addExercise() {
      exerciseCount++;
      const newExercise = exerciseTemplate.replace(/\{\{index\}\}/g, exerciseCount);
      document.getElementById("exercisesContainer").insertAdjacentHTML('beforeend', newExercise);
      reindexExercises();
      initMathFieldsForExercise(exerciseCount);
      document.querySelectorAll('.remove-exercise').forEach(btn => btn.style.display = 'flex');
      showNotification(langJs === 'en' ? `Exercise added` : `Exercice ajout√©`, 'success');
    }

    // FONCTION CORRIG√âE POUR SUPPRIMER UN EXERCICE
    function removeExercise(index) {
      const exercise = document.querySelector(`.exercise-card[data-exercise="${index}"]`);
      if (exercise && exerciseCount > 1) {
        exercise.remove();
        reindexExercises();
        if (exerciseCount === 1) document.querySelector('.remove-exercise').style.display = 'none';
        showNotification(langJs === 'en' ? 'Exercise removed' : 'Exercice supprim√©', 'success');
      }
    }

    function initMathFieldsForExercise(exerciseIndex) {
      const fields = ['question_fr', 'reponse_fr', 'options_fr', 'explication_fr', 'question_en', 'reponse_en', 'explication_en', 'options_en'];
      fields.forEach(field => {
        const mathField = document.getElementById(`${field}_field_${exerciseIndex}`);
        const textArea = document.getElementById(`${field}_${exerciseIndex}`);
        if (mathField && textArea) {
          mathField.addEventListener('input', () => textArea.value = mathField.value);
        }
      });
    }

    function toggleOptionalFields(exerciseIndex, button) {
      const optionalFields = document.getElementById(`optional-fields-${exerciseIndex}`);
      const icon = button.querySelector('i');
      if (optionalFields.classList.contains('show')) {
        optionalFields.classList.remove('show');
        icon.className = 'fas fa-plus-circle';
        button.innerHTML = `<i class="fas fa-plus-circle"></i> ${langJs === 'en' ? 'Show additional fields (optional)' : 'Afficher les champs suppl√©mentaires (facultatifs)'}`;
      } else {
        optionalFields.classList.add('show');
        icon.className = 'fas fa-minus-circle';
        button.innerHTML = `<i class="fas fa-minus-circle"></i> ${langJs === 'en' ? 'Hide additional fields' : 'Masquer les champs suppl√©mentaires'}`;
      }
    }

    function applyToAll(type) {
      const commonTime = document.getElementById('temps_commun').value;
      const exercises = document.querySelectorAll('.exercise-card');
      exercises.forEach((exercise, index) => {
        const exerciseIndex = index + 1;
        if (type === 'temps') {
          const timeInput = document.getElementById(`temps_${exerciseIndex}`);
          if (timeInput) timeInput.value = commonTime;
        }
      });
      showNotification(langJs === 'en' ? 'Applied to all exercises' : 'Appliqu√© √† tous les exercices', 'success');
    }

    function initMathFields() {
      const fields = ['question_fr', 'reponse_fr', 'options_fr', 'explication_fr', 'question_en', 'reponse_en', 'explication_en', 'options_en'];
      fields.forEach(field => {
        const mathField = document.getElementById(`${field}_field_1`);
        const textArea = document.getElementById(`${field}_1`);
        if (mathField && textArea) {
          mathField.addEventListener('input', () => textArea.value = mathField.value);
        }
      });
    }

    function initFileUploads() {
      document.querySelectorAll('.exercise-image').forEach(input => {
        if (input.id === 'image_exercice_1') {
          input.addEventListener('change', function() { previewImage(this, 1); });
        }
      });
    }

    function previewImage(input, exerciseIndex) {
      const preview = document.getElementById(`imagePreview-${exerciseIndex}`);
      const previewImage = preview.querySelector('.previewImage');
      const fileName = input.closest('.file-upload').querySelector('.file-name');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          preview.style.display = 'block';
        }
        reader.readAsDataURL(input.files[0]);
        fileName.textContent = input.files[0].name;
      } else {
        preview.style.display = 'none';
        fileName.textContent = langJs === 'en' ? 'Choose an image...' : 'Choisir une image...';
      }
    }

    function insererLatex(fieldId) {
      const textarea = document.getElementById(fieldId);
      const mathFieldId = fieldId + "_field";
      const mathField = document.getElementById(mathFieldId);
      if (textarea && mathField && mathField.value.trim()) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        const insertion = mathField.value.trim();
        textarea.value = before + insertion + after;
        textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
        textarea.focus();
        showNotification(langJs === 'en' ? 'Formula inserted!' : 'Formule ins√©r√©e !', 'success');
      }
    }

    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    async function loadMatieres(niveauId, matiereSelect) {
      if (!niveauId) return;
      matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      matiereSelect.disabled = true;
      try {
        const res = await fetch(`/api/matieres?niveau_id=${niveauId}`);
        const matieres = await res.json();
        matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose subject --' : '-- Choisir une mati√®re --'}</option>`;
        matieres.forEach(m => matiereSelect.innerHTML += `<option value="${m.id}">${m.nom_en || m.nom}</option>`);
        matiereSelect.disabled = false;
      } catch (error) {
        console.error('Error loading subjects:', error);
        matiereSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Error' : 'Erreur'}</option>`;
      }
    }

    async function loadUnites(matiereId, uniteSelect) {
      if (!matiereId) return;
      uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      uniteSelect.disabled = true;
      try {
        const res = await fetch(`/api/unites?matiere_id=${matiereId}`);
        const unites = await res.json();
        uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose unit --' : '-- Choisir une unit√© --'}</option>`;
        unites.forEach(u => uniteSelect.innerHTML += `<option value="${u.id}">${u.nom_en || u.nom}</option>`);
        uniteSelect.disabled = false;
      } catch (error) {
        console.error('Error loading units:', error);
        uniteSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Error' : 'Erreur'}</option>`;
      }
    }

    async function loadLecons(uniteId, leconSelect) {
      if (!uniteId) return;
      leconSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Loading...' : 'Chargement...'}</option>`;
      leconSelect.disabled = true;
      try {
        const res = await fetch(`/api/lecons?unite_id=${uniteId}&lang=${langJs}`);
        const lecons = await res.json();
        leconSelect.innerHTML = `<option value="">${langJs === 'en' ? '-- Choose lesson --' : '-- Choisir une le√ßon --'}</option>`;
        lecons.forEach(l => leconSelect.innerHTML += `<option value="${l.id}">${l.titre}</option>`);
        leconSelect.disabled = false;
      } catch (error) {
        console.error('Error loading lessons:', error);
        leconSelect.innerHTML = `<option value="">${langJs === 'en' ? 'Error' : 'Erreur'}</option>`;
      }
    }

    function setupNavigation() {
      const backLink = document.querySelector('.back-link a');
      if (backLink) backLink.addEventListener('click', function(e) { e.preventDefault(); window.location.href = this.href; });
    }

    // Gestion de la soumission du formulaire - AVEC R√âINDEXATION OBLIGATOIRE
    document.getElementById('exerciseForm').addEventListener('submit', function(e) {
      reindexExercises();
      const niveauSelect = document.getElementById('niveau');
      const leconSelect = document.getElementById('lecon');
      if (!niveauSelect || !niveauSelect.value) {
        e.preventDefault();
        showNotification(langJs === 'en' ? 'Please select a level' : 'Veuillez s√©lectionner un niveau', 'error');
        niveauSelect.focus();
        return;
      }
      if (!leconSelect || !leconSelect.value) {
        e.preventDefault();
        showNotification(langJs === 'en' ? 'Please select a lesson' : 'Veuillez s√©lectionner une le√ßon', 'error');
        leconSelect.focus();
        return;
      }
      let isValid = true;
      const exerciseCards = document.querySelectorAll('.exercise-card');
      exerciseCards.forEach((exercise, index) => {
        const exerciseIndex = index + 1;
        const questionFr = document.getElementById(`question_fr_${exerciseIndex}`);
        const questionEn = document.getElementById(`question_en_${exerciseIndex}`);
        if (!questionFr || !questionFr.value.trim()) {
          isValid = false;
          questionFr.style.borderColor = '#e74c3c';
        } else questionFr.style.borderColor = '';
        if (!questionEn || !questionEn.value.trim()) {
          isValid = false;
          questionEn.style.borderColor = '#e74c3c';
        } else questionEn.style.borderColor = '';
      });
      if (!isValid) {
        e.preventDefault();
        showNotification(langJs === 'en' ? 'Please fill the question for each exercise' : 'Veuillez remplir la question pour chaque exercice', 'error');
        return;
      }
      submitBtn.innerHTML = `<span class="loading"></span> ${langJs === 'en' ? 'Saving...' : 'Enregistrement...'}`;
      submitBtn.disabled = true;
    });
  </script>
</body>
</html>
