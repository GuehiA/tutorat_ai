<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Register Student - Admin' if lang == 'en' else 'Inscrire Élève - Admin' }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --border: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .registration-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            animation: slideUp 0.5s ease-out;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* BOUTON RETOUR */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            z-index: 10;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
            background: linear-gradient(135deg, #5a6268, #343a40);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            margin-top: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .logo i {
            font-size: 32px;
            color: white;
        }

        h2 {
            color: var(--dark);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .section-title {
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        label::after {
            content: " *";
            color: var(--danger);
        }

        .optional label::after {
            content: " ({{ 'optional' if lang == 'en' else 'optionnel' }})";
            color: #6c757d;
        }

        .form-control, .form-select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
            padding: 5px 10px;
            background: #fee;
            border-radius: 5px;
            border-left: 3px solid var(--danger);
        }

        .status-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            border-left: 3px solid var(--primary);
        }

        .status-info small {
            color: #6c757d;
            line-height: 1.4;
        }

        .btn-submit {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .registration-box {
                padding: 30px 20px;
                margin: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            body {
                padding: 10px;
                align-items: flex-start;
            }

            .back-btn {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
                width: 100%;
            }

            .header {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="registration-box">
        <!-- BOUTON RETOUR -->
        <a href="{{ url_for('admin_dashboard') }}?lang={{ lang }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            {{ 'Back to Admin Dashboard' if lang == 'en' else 'Retour au Tableau de Bord Admin' }}
        </a>

        <div class="header">
            <div class="logo">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h2>{{ 'Register Student (Admin)' if lang == 'en' else 'Inscrire un Élève (Admin)' }}</h2>
            <p style="color: #6c757d; margin-top: 10px;">
                {{ 'Create student accounts with administrative privileges' if lang == 'en' else 'Créer des comptes élèves avec privilèges administratifs' }}
            </p>
        </div>

        <form method="POST" id="studentForm">
            {{ form.hidden_tag() }}
            <input type="hidden" name="lang" value="{{ lang }}">

            <!-- SECTION 1: INFORMATIONS ÉLÈVE -->
            <div class="section-title">
                <i class="fas fa-user"></i>
                {{ 'Student Information' if lang == 'en' else 'Informations de l\'Élève' }}
            </div>

            <div class="form-grid">
                <!-- USERNAME -->
                <div class="form-group">
                    <label for="username">{{ 'Username' if lang == 'en' else 'Nom d\'utilisateur' }}</label>
                    {{ form.username(class="form-control", placeholder="john_doe") }}
                    {% if form.username.errors %}
                        <div class="error-message">
                            {% for error in form.username.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- EMAIL -->
                <div class="form-group">
                    <label for="email">{{ 'Email' if lang == 'en' else 'Email' }}</label>
                    {{ form.email(class="form-control", placeholder="email@example.com") }}
                    {% if form.email.errors %}
                        <div class="error-message">
                            {% for error in form.email.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- FULL NAME -->
                <div class="form-group">
                    <label for="nom_complet">{{ 'Full Name' if lang == 'en' else 'Nom Complet' }}</label>
                    {{ form.nom_complet(class="form-control", placeholder="John Doe") }}
                    {% if form.nom_complet.errors %}
                        <div class="error-message">
                            {% for error in form.nom_complet.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- PASSWORD -->
                <div class="form-group">
                    <label for="mot_de_passe">{{ 'Password' if lang == 'en' else 'Mot de Passe' }}</label>
                    {{ form.mot_de_passe(class="form-control", placeholder="••••••") }}
                    {% if form.mot_de_passe.errors %}
                        <div class="error-message">
                            {% for error in form.mot_de_passe.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- PHONE -->
                <div class="form-group optional">
                    <label for="telephone">{{ 'Phone (Optional)' if lang == 'en' else 'Téléphone (Optionnel)' }}</label>
                    {{ form.telephone(class="form-control", placeholder="+1 (555) 123-4567") }}
                </div>

                <!-- BIRTH DATE -->
                <div class="form-group optional">
                    <label for="date_naissance">{{ 'Birth Date (Optional)' if lang == 'en' else 'Date de Naissance (Optionnel)' }}</label>
                    {{ form.date_naissance(class="form-control", type="date") }}
                </div>

                <!-- CITY -->
                <div class="form-group optional">
                    <label for="ville">{{ 'City (Optional)' if lang == 'en' else 'Ville (Optionnel)' }}</label>
                    {{ form.ville(class="form-control", placeholder="Montréal") }}
                </div>

                <!-- PROVINCE -->
                <div class="form-group optional">
                    <label for="province">{{ 'Province (Optional)' if lang == 'en' else 'Province (Optionnel)' }}</label>
                    {{ form.province(class="form-select") }}
                </div>

                <!-- POSTAL CODE -->
                <div class="form-group optional">
                    <label for="code_postal">{{ 'Postal Code (Optional)' if lang == 'en' else 'Code Postal (Optionnel)' }}</label>
                    {{ form.code_postal(class="form-control", placeholder="H1A 1A1") }}
                </div>

                <!-- ADDRESS -->
                <div class="form-group full-width optional">
                    <label for="adresse">{{ 'Address (Optional)' if lang == 'en' else 'Adresse (Optionnel)' }}</label>
                    {{ form.adresse(class="form-control", rows="2", placeholder="123 Rue Principale...") }}
                </div>
            </div>

            <!-- SECTION 2: INFORMATIONS PARENT -->
            <div class="section-title">
                <i class="fas fa-users"></i>
                {{ 'Parent Information' if lang == 'en' else 'Informations du Parent' }}
            </div>

            <div class="form-grid">
                <!-- PARENT EMAIL -->
                <div class="form-group">
                    <label for="parent_email">{{ 'Parent Email' if lang == 'en' else 'Email du Parent' }}</label>
                    {{ form.parent_email(class="form-control", placeholder="parent@example.com") }}
                    {% if form.parent_email.errors %}
                        <div class="error-message">
                            {% for error in form.parent_email.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- PARENT NAME -->
                <div class="form-group">
                    <label for="responsable_nom">{{ 'Parent Name' if lang == 'en' else 'Nom du Parent' }}</label>
                    {{ form.responsable_nom(class="form-control", placeholder="Jane Doe") }}
                    {% if form.responsable_nom.errors %}
                        <div class="error-message">
                            {% for error in form.responsable_nom.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- PARENT PHONE -->
                <div class="form-group">
                    <label for="responsable_telephone">{{ 'Parent Phone' if lang == 'en' else 'Téléphone du Parent' }}</label>
                    {{ form.responsable_telephone(class="form-control", placeholder="+1 (555) 987-6543") }}
                    {% if form.responsable_telephone.errors %}
                        <div class="error-message">
                            {% for error in form.responsable_telephone.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- LEVEL -->
                <div class="form-group">
                    <label for="niveau_id">{{ 'Level' if lang == 'en' else 'Niveau' }}</label>
                    <select name="niveau_id" id="niveau_id" class="form-select" required>
                        <option value="">{{ 'Select a level' if lang == 'en' else 'Sélectionnez un niveau' }}</option>
                        {% for niveau in form.niveau_id.choices %}
                            {% set niveau_id, niveau_nom = niveau %}
                            {% set niveau_obj = Niveau.query.get(niveau_id) if 'Niveau' in globals() else None %}
                            <option value="{{ niveau_id }}">
                                {% if niveau_obj and lang == 'en' and niveau_obj.nom_en %}
                                    {{ niveau_obj.nom_en }}
                                {% else %}
                                    {{ niveau_nom }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.niveau_id.errors %}
                        <div class="error-message">
                            {% for error in form.niveau_id.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- SECTION 3: STATUT ET ADMINISTRATION -->
            <div class="section-title">
                <i class="fas fa-cog"></i>
                {{ 'Administrative Settings' if lang == 'en' else 'Paramètres Administratifs' }}
            </div>

            <div class="form-grid">
                <!-- STATUS -->
                <div class="form-group">
                    <label for="statut">{{ 'Status' if lang == 'en' else 'Statut' }}</label>
                    <select name="statut" id="statut" class="form-select">
                        <option value="actif">{{ 'Active' if lang == 'en' else 'Actif' }}</option>
                        <option value="inactif">{{ 'Inactive' if lang == 'en' else 'Inactif' }}</option>
                        <option value="en_attente">{{ 'Pending' if lang == 'en' else 'En attente' }}</option>
                    </select>
                    <div class="status-info">
                        <small>
                            {% if lang == 'en' %}
                                • <strong>Active:</strong> Full platform access<br>
                                • <strong>Inactive:</strong> No access<br>
                                • <strong>Pending:</strong> Limited access
                            {% else %}
                                • <strong>Actif:</strong> Accès complet<br>
                                • <strong>Inactif:</strong> Aucun accès<br>
                                • <strong>En attente:</strong> Accès limité
                            {% endif %}
                        </small>
                    </div>
                </div>

                <!-- PAYMENT STATUS -->
                <div class="form-group">
                    <label for="statut_paiement">{{ 'Payment Status' if lang == 'en' else 'Statut de paiement' }}</label>
                    <select name="statut_paiement" id="statut_paiement" class="form-select">
                        <option value="paye">{{ 'Paid' if lang == 'en' else 'Payé' }}</option>
                        <option value="essai_gratuit">{{ 'Free Trial' if lang == 'en' else 'Essai gratuit' }}</option>
                        <option value="en_attente">{{ 'Pending' if lang == 'en' else 'En attente' }}</option>
                        <option value="non_paye">{{ 'Not Paid' if lang == 'en' else 'Non payé' }}</option>
                    </select>
                    <div class="status-info">
                        <small>
                            {% if lang == 'en' %}
                                • <strong>Paid:</strong> Full access<br>
                                • <strong>Free Trial:</strong> 48-hour trial<br>
                                • <strong>Pending:</strong> Payment required<br>
                                • <strong>Not Paid:</strong> Limited access
                            {% else %}
                                • <strong>Payé:</strong> Accès complet<br>
                                • <strong>Essai gratuit:</strong> Essai de 48h<br>
                                • <strong>En attente:</strong> Paiement requis<br>
                                • <strong>Non payé:</strong> Accès limité
                            {% endif %}
                        </small>
                    </div>
                </div>

                <!-- CHECKBOXES -->
                <div class="form-group full-width">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- EMAIL VERIFIED -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {{ form.email_verifie(class="form-control", style="width: auto;") }}
                            <label for="email_verifie" style="margin-bottom: 0; font-weight: normal;">
                                {{ 'Email Verified' if lang == 'en' else 'Email Vérifié' }}
                            </label>
                        </div>
                        
                        <!-- PHONE VERIFIED -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {{ form.telephone_verifie(class="form-control", style="width: auto;") }}
                            <label for="telephone_verifie" style="margin-bottom: 0; font-weight: normal;">
                                {{ 'Phone Verified' if lang == 'en' else 'Téléphone Vérifié' }}
                            </label>
                        </div>
                        
                        <!-- TERMS ACCEPTED -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {{ form.accepte_cgu(class="form-control", style="width: auto;") }}
                            <label for="accepte_cgu" style="margin-bottom: 0; font-weight: normal;">
                                {{ 'Terms Accepted' if lang == 'en' else 'CGU Acceptées' }}
                            </label>
                        </div>
                    </div>
                </div>

                <!-- TEACHER REFERENCE (optional) -->
                <div class="form-group optional full-width">
                    <label for="enseignant_id">{{ 'Reference Teacher (Optional)' if lang == 'en' else 'Enseignant Référent (Optionnel)' }}</label>
                    <select name="enseignant_id" id="enseignant_id" class="form-select">
                        <option value="">{{ 'No teacher assigned' if lang == 'en' else 'Aucun enseignant assigné' }}</option>
                        {% if enseignants %}
                            {% for enseignant in enseignants %}
                                <option value="{{ enseignant.id }}">
                                    {{ enseignant.nom }} ({{ enseignant.email }})
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>

            <!-- SUBMIT BUTTON -->
            <button type="submit" class="btn-submit" onclick="return validateForm()">
                <i class="fas fa-user-plus"></i>
                {{ 'Register Student' if lang == 'en' else 'Inscrire l\'élève' }}
            </button>
        </form>
    </div>

    <script>
        function validateForm() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('mot_de_passe').value;
            const parentEmail = document.getElementById('parent_email').value;
            const parentName = document.getElementById('responsable_nom').value;
            const level = document.getElementById('niveau_id').value;
            
            // Validation basique
            if (username.length < 3) {
                alert('{{ "Username must be at least 3 characters" if lang == "en" else "Le nom d\'utilisateur doit contenir au moins 3 caractères" }}');
                return false;
            }
            
            if (password.length < 3) {
                alert('{{ "Password must be at least 3 characters" if lang == "en" else "Le mot de passe doit contenir au moins 3 caractères" }}');
                return false;
            }
            
            if (!level) {
                alert('{{ "Please select a level" if lang == "en" else "Veuillez sélectionner un niveau" }}');
                return false;
            }
            
            // Validation email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('{{ "Please enter a valid email address" if lang == "en" else "Veuillez entrer une adresse email valide" }}');
                return false;
            }
            
            // Validation email parent si fourni
            if (parentEmail && !emailRegex.test(parentEmail)) {
                alert('{{ "Please enter a valid parent email address" if lang == "en" else "Veuillez entrer une adresse email parent valide" }}');
                return false;
            }
            
            // Confirmation avant soumission
            return confirm('{{ "Are you sure you want to register this student?" if lang == "en" else "Êtes-vous sûr de vouloir inscrire cet élève ?" }}');
        }

        // Initialisation des sélecteurs
        document.addEventListener('DOMContentLoaded', function() {
            // Mettre le statut par défaut à "actif"
            document.getElementById('statut').value = 'actif';
            
            // Mettre le statut de paiement par défaut à "paye" pour admin
            document.getElementById('statut_paiement').value = 'paye';
            
            // Cocher les cases par défaut pour admin
            document.getElementById('email_verifie').checked = true;
            document.getElementById('telephone_verifie').checked = true;
            document.getElementById('accepte_cgu').checked = true;
            
            // Désactiver le bouton de soumission pendant le chargement
            const form = document.getElementById('studentForm');
            const submitBtn = form.querySelector('.btn-submit');
            
            form.addEventListener('submit', function() {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ "Registering..." if lang == "en" else "Inscription en cours..." }}';
                submitBtn.disabled = true;
            });
        });
    </script>
</body>
</html>