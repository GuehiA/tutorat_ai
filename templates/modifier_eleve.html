<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <!-- Favicon VirtuEduc -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
  <meta name="msapplication-TileColor" content="#4361ee">
  <meta name="theme-color" content="#4361ee">
  <title>{{ 'Edit Student' if lang == 'en' else 'Modifier un √âl√®ve' }}</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f4f4f4; 
      padding: 30px; 
    }
    .form-container {
      background: #fff; 
      padding: 25px; 
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      max-width: 500px; 
      margin: auto;
    }
    h2 { 
      text-align: center; 
      color: #333; 
      margin-bottom: 20px;
    }
    label { 
      display: block; 
      margin-top: 15px; 
      font-weight: bold; 
      color: #555;
    }
    input, select {
      width: 100%; 
      padding: 10px; 
      margin-top: 5px;
      border: 1px solid #ccc; 
      border-radius: 5px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }
    button {
      margin-top: 20px; 
      width: 100%; 
      padding: 12px;
      background: #3498db; 
      color: white; 
      border: none;
      border-radius: 5px; 
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { 
      background: #2980b9; 
    }
    .top-links {
      margin-bottom: 20px;
      text-align: center;
    }
    .top-links a {
      margin: 0 10px;
      color: white;
      background: #2ecc71;
      padding: 8px 12px;
      border-radius: 5px;
      text-decoration: none;
      transition: background 0.3s;
    }
    .top-links a:hover {
      background: #27ae60;
    }
    .danger { 
      background: #e74c3c !important; 
    }
    .danger:hover { 
      background: #c0392b !important; 
    }
    .password-section {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      border-left: 4px solid #3498db;
    }
    .password-toggle {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .password-toggle input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .password-fields {
      display: none;
      margin-top: 10px;
    }
    .password-fields.show {
      display: block;
    }
    .info-text {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }
    .current-password {
      background: #e8f4fc;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 5px;
      font-family: monospace;
    }
    .alert {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      font-weight: bold;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

<div class="top-links">
  <a href="/admin/dashboard{% if lang %}?lang={{ lang }}{% endif %}">
    üè† {{ 'Dashboard' if lang == 'en' else 'Tableau de bord' }}
  </a>
  <a href="/admin/eleves{% if lang %}?lang={{ lang }}{% endif %}">
    üìã {{ 'Students List' if lang == 'en' else 'Liste des √©l√®ves' }}
  </a>
  <a href="/logout{% if lang %}?lang={{ lang }}{% endif %}" class="danger">
    üö™ {{ 'Logout' if lang == 'en' else 'D√©connexion' }}
  </a>
</div>

<div class="form-container">
  <h2>{{ 'Edit Student' if lang == 'en' else 'Modifier un √âl√®ve' }}</h2>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST">
    <input type="hidden" name="lang" value="{{ lang }}">
    
    <!-- Informations de base -->
    <label for="nom">{{ 'Full Name' if lang == 'en' else 'Nom complet' }}</label>
    <input type="text" id="nom" name="nom" value="{{ eleve.nom_complet }}" required>

    <label for="email">{{ 'Email Address' if lang == 'en' else 'Adresse e-mail' }}</label>
    <input type="email" id="email" name="email" value="{{ eleve.email }}" required>

    <label for="username">{{ 'Username' if lang == 'en' else 'Nom d\'utilisateur' }}</label>
    <input type="text" id="username" name="username" value="{{ eleve.username }}" required>
    <div class="info-text">{{ 'Used for student login' if lang == 'en' else 'Utilis√© pour la connexion de l\'√©l√®ve' }}</div>

    <label for="niveau_id">{{ 'Level' if lang == 'en' else 'Niveau' }}</label>
    <select id="niveau_id" name="niveau_id" required>
      <option value="">-- {{ 'Choose a level' if lang == 'en' else 'Choisir un niveau' }} --</option>
      {% for niveau in niveaux %}
      <option value="{{ niveau.id }}" {% if eleve.niveau_id == niveau.id %}selected{% endif %}>
        {% if lang == 'en' and niveau.nom_en %}
          {{ niveau.nom_en }}
        {% else %}
          {{ niveau.nom }}
        {% endif %}
      </option>
      {% endfor %}
    </select>

    <label for="enseignant_id">{{ 'Reference Teacher' if lang == 'en' else 'Enseignant r√©f√©rent' }}</label>
    <select id="enseignant_id" name="enseignant_id" required>
      <option value="">-- {{ 'Choose a teacher' if lang == 'en' else 'Choisir un enseignant' }} --</option>
      {% for enseignant in enseignants %}
      <option value="{{ enseignant.id }}" {% if eleve.enseignant_id == enseignant.id %}selected{% endif %}>
        {{ enseignant.nom }} ({{ enseignant.email }})
      </option>
      {% endfor %}
    </select>

    <!-- Section mot de passe -->
    <div class="password-section">
      <h3 style="margin-top: 0; color: #2c3e50;">
        üîê {{ 'Password' if lang == 'en' else 'Mot de passe' }}
      </h3>
      
      <div class="password-toggle">
        <input type="checkbox" id="changer_mdp" name="changer_mdp" onchange="togglePasswordFields()">
        <label for="changer_mdp" style="display: inline; margin-top: 0;">
          {{ 'Change password' if lang == 'en' else 'Modifier le mot de passe' }}
        </label>
      </div>

      <div class="info-text">
        {{ 'If you do not change the password, the old one will remain unchanged.' if lang == 'en' else 'Si vous ne modifiez pas le mot de passe, l\'ancien restera inchang√©.' }}
      </div>

      <div id="password-fields" class="password-fields">
        <label for="nouveau_mot_de_passe">{{ 'New password' if lang == 'en' else 'Nouveau mot de passe' }}</label>
        <input type="password" id="nouveau_mot_de_passe" name="nouveau_mot_de_passe" 
               placeholder="{{ 'Leave empty to keep current' if lang == 'en' else 'Laisser vide pour garder l\'actuel' }}">
        
        <label for="confirmation_mot_de_passe">{{ 'Password confirmation' if lang == 'en' else 'Confirmation du mot de passe' }}</label>
        <input type="password" id="confirmation_mot_de_passe" name="confirmation_mot_de_passe" 
               placeholder="{{ 'Repeat the new password' if lang == 'en' else 'R√©p√©tez le nouveau mot de passe' }}">
        
        <div class="info-text">
          {{ 'üí° Tip: Use an easy-to-remember password for the student' if lang == 'en' else 'üí° Conseil : Utilisez un mot de passe facile √† retenir pour l\'√©l√®ve' }}
        </div>
      </div>
    </div>

    <!-- Statut et informations suppl√©mentaires -->
    <label for="statut">{{ 'Status' if lang == 'en' else 'Statut' }}</label>
    <select id="statut" name="statut">
      <option value="actif" {% if eleve.statut == 'actif' %}selected{% endif %}>
        {{ 'Active' if lang == 'en' else 'Actif' }}
      </option>
      <option value="inactif" {% if eleve.statut == 'inactif' %}selected{% endif %}>
        {{ 'Inactive' if lang == 'en' else 'Inactif' }}
      </option>
      <option value="suspendu" {% if eleve.statut == 'suspendu' %}selected{% endif %}>
        {{ 'Suspended' if lang == 'en' else 'Suspendu' }}
      </option>
    </select>

    <label for="statut_paiement">{{ 'Payment Status' if lang == 'en' else 'Statut de paiement' }}</label>
    <select id="statut_paiement" name="statut_paiement">
      <option value="paye" {% if eleve.statut_paiement == 'paye' %}selected{% endif %}>
        {{ 'Paid' if lang == 'en' else 'Pay√©' }}
      </option>
      <option value="essai_gratuit" {% if eleve.statut_paiement == 'essai_gratuit' %}selected{% endif %}>
        {{ 'Free Trial' if lang == 'en' else 'Essai gratuit' }}
      </option>
      <option value="en_attente" {% if eleve.statut_paiement == 'en_attente' %}selected{% endif %}>
        {{ 'Pending' if lang == 'en' else 'En attente' }}
      </option>
      <option value="expire" {% if eleve.statut_paiement == 'expire' %}selected{% endif %}>
        {{ 'Expired' if lang == 'en' else 'Expir√©' }}
      </option>
    </select>

    <!-- Informations de contact optionnelles -->
    <label for="telephone">{{ 'Phone (Optional)' if lang == 'en' else 'T√©l√©phone (Optionnel)' }}</label>
    <input type="tel" id="telephone" name="telephone" value="{{ eleve.telephone or '' }}"
           placeholder="+1 (555) 123-4567">

    <!-- Bouton de soumission -->
    <button type="submit" onclick="return validateForm()">
      üíæ {{ 'Save Changes' if lang == 'en' else 'Enregistrer les modifications' }}
    </button>
  </form>
</div>

<script>
  function togglePasswordFields() {
    const checkbox = document.getElementById('changer_mdp');
    const passwordFields = document.getElementById('password-fields');
    
    if (checkbox.checked) {
      passwordFields.classList.add('show');
    } else {
      passwordFields.classList.remove('show');
      // R√©initialiser les champs de mot de passe
      document.getElementById('nouveau_mot_de_passe').value = '';
      document.getElementById('confirmation_mot_de_passe').value = '';
    }
  }

  function validateForm() {
    const changerMdp = document.getElementById('changer_mdp').checked;
    const nouveauMdp = document.getElementById('nouveau_mot_de_passe').value;
    const confirmationMdp = document.getElementById('confirmation_mot_de_passe').value;
    
    if (changerMdp) {
      if (nouveauMdp.length < 3) {
        alert('{{ "Password must be at least 3 characters" if lang == "en" else "Le mot de passe doit contenir au moins 3 caract√®res" }}');
        return false;
      }
      
      if (nouveauMdp !== confirmationMdp) {
        alert('{{ "Passwords do not match" if lang == "en" else "Les mots de passe ne correspondent pas" }}');
        return false;
      }
    }
    
    return true;
  }

  // Initialiser l'√©tat des champs de mot de passe au chargement
  document.addEventListener('DOMContentLoaded', function() {
    togglePasswordFields();
  });

  // Afficher/cacher le bouton de retour admin
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromAdmin = urlParams.get('from_admin') === 'true';
    
    if (!fromAdmin) {
      // Ajouter un bouton de retour au tableau de bord √©l√®ve si on vient de l√†
      const topLinks = document.querySelector('.top-links');
      const dashboardLink = document.createElement('a');
      dashboardLink.href = "/dashboard-eleve?username={{ eleve.username }}&lang={{ lang }}";
      dashboardLink.innerHTML = 'üë§ {{ "Student Dashboard" if lang == "en" else "Tableau de bord √©l√®ve" }}';
      dashboardLink.style.background = '#9b59b6';
      dashboardLink.style.marginLeft = '10px';
      dashboardLink.onmouseover = function() { this.style.background = '#8e44ad'; };
      dashboardLink.onmouseout = function() { this.style.background = '#9b59b6'; };
      topLinks.appendChild(dashboardLink);
    }
  });
</script>

</body>
</html>