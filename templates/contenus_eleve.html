<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
<meta charset="UTF-8">
<title>Explorer les leÃ§ons</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --primary:#4f46e5;
  --border:#e5e7eb;
}
body.dark{
  --bg:#0f172a;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --primary:#818cf8;
  --border:#1e293b;
}

body{
  margin:0;
  font-family:Inter,system-ui,-apple-system;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:auto;
  padding:24px;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
}

h1{
  font-size:1.8rem;
  margin:0;
}

.toggle-theme{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 14px;
  cursor:pointer;
  color:var(--text);
}

/* ===== MATIÃˆRES ===== */
.matiere{
  background:var(--card);
  border-radius:18px;
  margin-bottom:16px;
  border:1px solid var(--border);
  overflow:hidden;
}

.matiere-header{
  padding:18px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.matiere-header:hover{
  background:rgba(79,70,229,.07);
}

.matiere-title{
  font-weight:600;
  font-size:1.05rem;
}

.matiere-msg{
  font-size:.85rem;
  color:var(--muted);
}

.matiere-body{
  display:none;
  padding:18px 20px 22px;
}

/* ===== UNITÃ‰S ===== */
.unite{
  background:rgba(0,0,0,.02);
  border-radius:14px;
  padding:14px 18px;
  margin-bottom:12px;
}

.unite-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  font-weight:600;
}

.unit-meta{
  font-size:.8rem;
  color:var(--muted);
}

.lecons{
  margin-top:10px;
}

/* ===== LEÃ‡ONS ===== */
.lecon{
  background:var(--card);
  border-radius:12px;
  padding:12px 14px;
  margin-top:8px;
  border-left:4px solid var(--primary);
}

.lecon a{
  color:var(--primary);
  font-weight:600;
  text-decoration:none;
}

/* ===== PROGRESS ===== */
.circle{
  width:40px;
  height:40px;
  border-radius:50%;
  background:
    conic-gradient(var(--primary) var(--p),var(--border) 0);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.7rem;
  font-weight:600;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>ðŸ“š Explorer les leÃ§ons</h1>
  <button class="toggle-theme" onclick="toggleTheme()">ðŸŒ™</button>
</header>

<!-- ZONE MATIÃˆRES -->
<div id="matiereZone"></div>

</div>

<script>
const niveauId = "{{ niveau_id }}";
const lang = "{{ lang }}";

/* DARK MODE */
function toggleTheme(){
  document.body.classList.toggle("dark");
}

/* CHARGEMENT MATIÃˆRES */
fetch(`/api/matieres?niveau_id=${niveauId}&lang=${lang}`)
  .then(r=>r.json())
  .then(matieres=>{
    const zone=document.getElementById("matiereZone");
    zone.innerHTML="";
    matieres.forEach(m=>{
      const box=document.createElement("div");
      box.className="matiere";
      box.innerHTML=`
        <div class="matiere-header">
          <div>
            <div class="matiere-title">${m.nom}</div>
            <div class="matiere-msg">
              ${m.nb_unites} unitÃ©${m.nb_unites>1?'s':''}
            </div>
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="matiere-body"></div>
      `;
      box.querySelector(".matiere-header").onclick=()=>toggleMatiere(box,m.id);
      zone.appendChild(box);
    });
  });

/* 1 SEULE MATIÃˆRE OUVERTE */
function toggleMatiere(box,id){
  document.querySelectorAll('.matiere').forEach(m=>{
    if(m!==box) m.querySelector('.matiere-body').style.display="none";
  });
  const body=box.querySelector('.matiere-body');
  if(body.style.display==="block"){
    body.style.display="none";
    return;
  }
  body.style.display="block";
  if(!body.dataset.loaded){
    loadUnites(id,body);
    body.dataset.loaded=1;
  }
}

/* CHARGER UNITÃ‰S */
function loadUnites(matiereId,container){
  container.innerHTML="Chargementâ€¦";
  fetch(`/api/unites?matiere_id=${matiereId}&lang=${lang}`)
    .then(r=>r.json())
    .then(unites=>{
      container.innerHTML="";
      unites.forEach(u=>{
        const unit=document.createElement("div");
        unit.className="unite";
        unit.innerHTML=`
          <div class="unite-header">
            <span>
              ${u.nom}
              <span class="unit-meta">
                Â· ${u.nb_lecons} leÃ§on${u.nb_lecons>1?'s':''}
              </span>
            </span>
            <div class="circle" style="--p:0%">0%</div>
          </div>
          <div class="lecons"></div>
        `;
        unit.querySelector(".unite-header").onclick=
          ()=>loadLecons(u.id,unit.querySelector(".lecons"));
        container.appendChild(unit);
      });
    });
}

/* CHARGER LEÃ‡ONS */
function loadLecons(uniteId,container){
  if(container.dataset.loaded) return;
  container.dataset.loaded=1;
  fetch(`/api/lecons?unite_id=${uniteId}&lang=${lang}`)
    .then(r=>r.json())
    .then(lecons=>{
      lecons.forEach(l=>{
        const div=document.createElement("div");
        div.className="lecon";
        div.innerHTML=`<a href="/lecon/${l.id}?lang=${lang}">${l.titre}</a>`;
        container.appendChild(div);
      });
    });
}
</script>

</body>
</html>
