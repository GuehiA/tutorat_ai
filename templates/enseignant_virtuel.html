<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}</title>

  <!-- Cache control STRICT -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Bootstrap for alerts only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [['\\[', '\\]']]
      },
      startup: {
        pageReady: () => MathJax.startup.defaultPageReady()
      }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --success: #3fba83;
      --warning: #fcc419;
      --danger: #e85959;
      --light: #f8f9ff;
      --dark: #121826;
      --accent: #9b59b6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
      margin: 0;
      padding: 15px;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      height: 100%;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .niveau-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Banni√®re de r√©m√©diation - CACH√âE SANS EXERCICE */
    .remediation-context-banner {
      background: linear-gradient(135deg, #e8f4ff 0%, #d1e7ff 100%);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 5px solid #4361ee;
      display: none;
    }

    /* S√©lecteur de mati√®re */
    .matiere-selector {
      margin-bottom: 15px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .matiere-selector label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .matiere-selector select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .matiere-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Bouton retour */
    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-3px);
    }

    /* Exercice en cours - CACH√â SI PAS D'EXERCICE */
    .exercice-header {
      background: #e8f4ff;
      border-left: 4px solid var(--primary);
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
      align-items: flex-start;
      gap: 10px;
    }

    .exercice-icon {
      color: var(--primary);
      font-size: 1.2rem;
      margin-top: 2px;
    }

    .exercice-content {
      flex: 1;
    }

    .exercice-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .exercice-text {
      color: #34495e;
      line-height: 1.4;
      font-size: 0.95rem;
    }

    .exercice-counter {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .controls form {
      margin: 0;
      flex: 1;
      display: flex;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      width: 100%;
      font-weight: 500;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-new {
      background: var(--success);
      color: white;
    }

    .btn-new:hover {
      background: #38a873;
    }

    /* Chat Container */
    .chat-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      height: calc(100vh - 250px);
      min-height: 500px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .messages-area::-webkit-scrollbar {
      width: 6px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    /* Messages */
    .message {
      margin-bottom: 15px;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      margin-left: auto;
    }

    .bot-message {
      margin-right: auto;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 15px;
      line-height: 1.4;
    }

    .user-message .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .bot-message .message-bubble {
      background: #f0f2f5;
      color: var(--dark);
      border-bottom-left-radius: 5px;
      border-left: 3px solid var(--primary);
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    /* Input Area */
    .input-area {
      border-top: 1px solid #e2e8f0;
      padding: 15px;
      background: white;
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      min-height: 60px;
      max-height: 150px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 1rem;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn-send {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      height: 60px;
      min-width: 60px;
      transition: all 0.3s ease;
    }

    .btn-send:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-send:not(:disabled):active {
      transform: scale(0.98);
    }

    /* Welcome message */
    .welcome-message .message-bubble {
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaff 100%);
      border-left: 4px solid var(--primary);
      padding: 20px;
    }

    .welcome-message h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .welcome-message ol {
      margin: 10px 0;
      padding-left: 20px;
    }

    .welcome-message li {
      margin-bottom: 8px;
    }

    /* Teacher's Last Question */
    .teacher-question {
      background: #fff9e6;
      border-left: 4px solid var(--warning);
      padding: 15px;
      margin: 15px 20px;
      border-radius: 8px;
      display: none;
    }

    .teacher-question h5 {
      margin: 0 0 8px 0;
      color: #e67e22;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Session info */
    .session-info {
      background: rgba(67, 97, 238, 0.1);
      border-radius: 8px;
      padding: 10px 15px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .session-matiere {
      background: var(--accent);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    /* Spinner */
    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Badge enseignant virtuel */
    .badge-enseignant {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 12px 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .header-left {
        width: 100%;
        justify-content: space-between;
      }

      .niveau-badge {
        align-self: flex-start;
        margin-top: 5px;
      }

      .btn-back span {
        display: none;
      }

      .btn-back {
        padding: 8px 12px;
      }

      .controls {
        flex-direction: column;
      }

      .exercice-header {
        flex-direction: column;
        gap: 8px;
      }

      .exercice-counter {
        align-self: flex-start;
      }

      .chat-container {
        height: calc(100vh - 270px);
      }

      .message {
        max-width: 90%;
      }

      .matiere-selector {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="student-info">
          <div class="avatar">
            {{ eleve.nom_complet.split(' ')[0][0] }}
            {{ eleve.nom_complet.split(' ')[1][0] if eleve.nom_complet.split(' ')|length > 1 else '' }}
          </div>
          <div>
            <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-robot"></i>
              {% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}
              <span class="badge-enseignant">
                <i class="fas fa-bolt"></i>
                {% if lang == 'en' %}24/7{% else %}24h/24{% endif %}
              </span>
            </h3>
            <p style="margin: 3px 0 0 0; opacity: 0.9; font-size: 0.85rem;">
              {{ eleve.nom_complet.split(' ')[0] }}
            </p>
          </div>
        </div>

        <!-- Bouton de retour au dashboard -->
        <a href="{{ url_for('dashboard_eleve') }}" class="btn-back">
          <i class="fas fa-arrow-left"></i>
          <span>{% if lang == 'en' %}Dashboard{% else %}Retour{% endif %}</span>
        </a>
      </div>

      <div class="niveau-badge">
        <i class="fas fa-graduation-cap"></i>
        {{ eleve.niveau.nom if eleve.niveau else ('6th grade' if lang == 'en' else '6√®me') }}
      </div>
    </header>

    <!-- Information de session -->
    <div class="session-info">
      <div>
        <i class="fas fa-clock" style="margin-right: 5px; color: var(--primary);"></i>
        <span id="currentTime">{{ date_du_jour.strftime('%H:%M') if date_du_jour else '' }}</span>
      </div>
      <div class="session-matiere" id="currentSubject">
        <i class="fas fa-book"></i>
        {{ matiere|default('math√©matiques' if lang == 'fr' else 'mathematics')|title }}
      </div>
    </div>

    <!-- S√©lecteur de mati√®re -->
    <div class="matiere-selector">
      <label for="matiere">
        <i class="fas fa-book-open"></i>
        {% if lang == 'en' %}Select Subject:{% else %}Choisir la mati√®re :{% endif %}
      </label>
      <select name="matiere" id="matiereSelect">
        {% if lang == 'fr' %}
          <option value="math√©matiques" {% if matiere == 'math√©matiques' %}selected{% endif %}>Math√©matiques</option>
          <option value="fran√ßais" {% if matiere == 'fran√ßais' %}selected{% endif %}>Fran√ßais</option>
          <option value="histoire" {% if matiere == 'histoire' %}selected{% endif %}>Histoire</option>
          <option value="sciences" {% if matiere == 'sciences' %}selected{% endif %}>Sciences</option>
          <option value="g√©ographie" {% if matiere == 'g√©ographie' %}selected{% endif %}>G√©ographie</option>
        {% else %}
          <option value="mathematics" {% if matiere == 'mathematics' %}selected{% endif %}>Mathematics</option>
          <option value="french" {% if matiere == 'french' %}selected{% endif %}>French</option>
          <option value="history" {% if matiere == 'history' %}selected{% endif %}>History</option>
          <option value="science" {% if matiere == 'science' %}selected{% endif %}>Science</option>
          <option value="geography" {% if matiere == 'geography' %}selected{% endif %}>Geography</option>
        {% endif %}
      </select>
    </div>

    <!-- Banni√®re de contexte de r√©m√©diation - AFFICH√âE SEULEMENT SI exercice_remediation existe -->
    {% if exercice_remediation %}
    <div class="remediation-context-banner" id="remediationBanner" style="display: block;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1;">
          <h4 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 1.1rem;">
            <i class="fas fa-life-ring" style="margin-right: 8px; color: #4361ee;"></i>
            {% if lang == 'en' %}Remediation Help{% else %}Aide √† la r√©m√©diation{% endif %}
          </h4>
          <p style="margin: 0; color: #34495e; font-size: 0.9rem;">
            {% if lang == 'en' %}
              Exercise: {{ exercice_remediation.question_en[:100] if exercice_remediation.question_en else 'Math exercise' }}...
            {% else %}
              Exercice : {{ exercice_remediation.question_fr[:100] if exercice_remediation.question_fr else 'Exercice de maths' }}...
            {% endif %}
          </p>
        </div>
        <div style="background: #4361ee; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
          {% if lang == 'en' %}Session {{ access_count }}/5{% else %}Session {{ access_count }}/5{% endif %}
        </div>
      </div>
      <p style="margin: 10px 0 0 0; font-size: 0.85rem; color: #666;">
        <i class="fas fa-lightbulb" style="margin-right: 5px;"></i>
        {% if lang == 'en' %}
          The virtual teacher will guide you to understand this exercise step by step.
        {% else %}
          L'enseignant virtuel vous guidera pour comprendre cet exercice √©tape par √©tape.
        {% endif %}
      </p>
    </div>
    {% endif %}

    <!-- Controls -->
    <div class="controls">
      <form method="POST" action="/nouvel-exercice" id="newExerciseForm">
        <button type="submit" class="btn btn-new" id="newExerciseBtn">
          <i class="fas fa-plus-circle"></i>
          {% if lang == 'en' %}New Conversation{% else %}Nouvelle Conversation{% endif %}
        </button>
      </form>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Messages Area -->
      <div class="messages-area" id="messagesArea">
        <!-- Conversation - AFFICH√âE SEULEMENT SI EXISTE -->
        {% set conversation = session.get('conversation', []) %}

        {% if conversation and conversation|length > 0 %}
          {% for message in conversation %}
            {% if 'üë§ Student:' in message or 'üë§ √âl√®ve:' in message %}
              <div class="message user-message">
                <div class="message-header">
                  <i class="fas fa-user"></i>
                  <span>{% if lang == 'en' %}You{% else %}Toi{% endif %}</span>
                </div>
                <div class="message-bubble">
                  {{ message.replace('üë§ Student: ', '').replace('üë§ √âl√®ve: ', '')|safe }}
                </div>
              </div>
            {% elif 'ü§ñ Teacher:' in message or 'ü§ñ Enseignant:' in message %}
              <div class="message bot-message">
                <div class="message-header">
                  <i class="fas fa-robot"></i>
                  <span>{% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}</span>
                </div>
                <div class="message-bubble">
                  {{ message.replace('ü§ñ Teacher: ', '').replace('ü§ñ Enseignant: ', '')|safe }}
                </div>
              </div>
            {% endif %}
          {% endfor %}

        {% else %}
          <!-- Welcome Message - TOUJOURS AFFICH√â QUAND PAS DE CONVERSATION -->
          <div class="message bot-message welcome-message">
            <div class="message-bubble">
              <h4><i class="fas fa-graduation-cap"></i>
                {% if lang == 'en' %}Hello {{ eleve.nom_complet.split(' ')[0] }}!{% else %}Bonjour {{ eleve.nom_complet.split(' ')[0] }} !{% endif %}
              </h4>

              <p><strong>{% if lang == 'en' %}I'm your Virtual Teacher{% else %}Je suis ton Enseignant Virtuel{% endif %}</strong>
                {% if lang == 'en' %}üë®‚Äçüè´{% else %}üë©‚Äçüè´{% endif %}
              </p>

              <p>{% if lang == 'en' %}
                I'm here to help you understand concepts and solve problems in any subject!
                <strong>I won't give direct answers</strong>, but I'll guide you step by step so you discover the solutions yourself.
              {% else %}
                Je suis l√† pour t'aider √† comprendre les concepts et r√©soudre des probl√®mes dans toutes les mati√®res !
                <strong>Je ne donnerai pas les r√©ponses directement</strong>, mais je te guiderai pas √† pas pour que tu d√©couvres les solutions toi-m√™me.
              {% endif %}</p>

              <p><strong>{% if lang == 'en' %}How to use:{% else %}Comment utiliser :{% endif %}</strong></p>
              <ol>
                <li>{% if lang == 'en' %}Select your subject above{% else %}Choisis ta mati√®re ci-dessus{% endif %}</li>
                <li>{% if lang == 'en' %}Ask your question{% else %}Pose ta question{% endif %}</li>
                <li>{% if lang == 'en' %}I'll guide you with questions{% else %}Je te guiderai avec des questions{% endif %}</li>
                <li>{% if lang == 'en' %}Answer my questions{% else %}R√©ponds √† mes questions{% endif %}</li>
                <li>{% if lang == 'en' %}Together we'll find the solution!{% else %}Ensemble on trouvera la solution !{% endif %}</li>
              </ol>

              <p style="margin-top: 15px; padding: 10px; background: rgba(67, 97, 238, 0.1); border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #fcc419;"></i>
                <strong>{% if lang == 'en' %}Pro tip:{% else %}Astuce :{% endif %}</strong>
                {% if lang == 'en' %}
                  You can ask about homework, exam preparation, concept explanations, or practice exercises.
                {% else %}
                  Tu peux poser des questions sur tes devoirs, la pr√©paration d'examens, l'explication de concepts ou des exercices d'entra√Ænement.
                {% endif %}
              </p>

              <p style="text-align: center; margin-top: 20px;">
                <em>‚ú® {% if lang == 'en' %}Ready to learn? Write your question below!{% else %}Pr√™t √† apprendre ? √âcris ta question ci-dessous !{% endif %}</em>
              </p>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Teacher's Last Question - AFFICH√â SEULEMENT SI EXISTE -->
      {% set derniere_q_ia = session.get('derniere_q_ia') %}
      {% if derniere_q_ia and conversation|length > 0 %}
      <div class="teacher-question" id="teacherQuestion" style="display: block;">
        <h5><i class="fas fa-question-circle"></i>
          {% if lang == 'en' %}My question for you:{% else %}Ma question pour toi :{% endif %}
        </h5>
        <p>{{ derniere_q_ia }}</p>
        <small style="color: #666; display: block; margin-top: 5px;">
          <i class="fas fa-hand-point-right"></i>
          {% if lang == 'en' %}Answer in the box below{% else %}R√©ponds dans la zone ci-dessous{% endif %}
        </small>
      </div>
      {% endif %}

      <!-- Input Area -->
      <div class="input-area">
        <!-- FORMULAIRE AVEC ACTION CORRECTE -->
        <form method="POST" action="{{ url_for('enseignant_virtuel') }}" id="mainForm">
          <!-- Champ cach√© pour la mati√®re -->
          <input type="hidden" name="matiere" id="matiereInput" value="{{ matiere|default('math√©matiques' if lang == 'fr' else 'mathematics') }}">

          <div class="input-group">
            <textarea
              name="question"
              id="questionInput"
              placeholder="{% if derniere_q_ia and conversation|length > 0 %}{% if lang == 'en' %}Answer the teacher's question...{% else %}R√©ponds √† la question de l'enseignant...{% endif %}{% else %}{% if lang == 'en' %}Ask your question about {{ matiere|default('mathematics') }}...{% else %}Pose ta question sur {{ matiere|default('math√©matiques') }}...{% endif %}{% endif %}"
              required
              autofocus
              rows="3"></textarea>

            <button type="submit" class="btn-send" id="submitBtn" title="{% if lang == 'en' %}Send message{% else %}Envoyer le message{% endif %}">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>

          <div style="display: flex; justify-content: space-between; margin-top: 8px;">
            <small style="color: #666; font-size: 0.85rem;">
              <i class="fas fa-keyboard"></i>
              {% if lang == 'en' %}Press Shift+Enter for new line{% else %}Shift+Entr√©e pour aller √† la ligne{% endif %}
            </small>
            <small id="charCount" style="color: #999; font-size: 0.85rem;">0/500</small>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS for alerts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JavaScript SIMPLIFI√â -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üì± Enseignant Virtuel - Page charg√©e");

      // √âl√©ments DOM
      const textarea = document.getElementById('questionInput');
      const submitBtn = document.getElementById('submitBtn');
      const matiereSelect = document.getElementById('matiereSelect');
      const matiereInput = document.getElementById('matiereInput');
      const currentSubject = document.getElementById('currentSubject');
      const charCount = document.getElementById('charCount');
      const form = document.getElementById('mainForm');

      // Auto-focus
      if (textarea) {
        textarea.focus();

        // Compteur de caract√®res
        textarea.addEventListener('input', function() {
          const length = this.value.length;
          if (charCount) {
            charCount.textContent = `${length}/500`;
            charCount.style.color = length > 450 ? '#e85959' : length > 300 ? '#fcc419' : '#999';
          }
        });

        // Initialiser le compteur
        if (charCount) {
          charCount.textContent = `${textarea.value.length}/500`;
        }
      }

      // S√©lecteur de mati√®re
      if (matiereSelect && matiereInput && currentSubject) {
        matiereSelect.addEventListener('change', function() {
          const selectedMatiere = this.value;
          matiereInput.value = selectedMatiere;

          // Mettre √† jour l'affichage
          const subjectNames = {
            'math√©matiques': 'Math√©matiques', 'fran√ßais': 'Fran√ßais', 'histoire': 'Histoire',
            'sciences': 'Sciences', 'g√©ographie': 'G√©ographie',
            'mathematics': 'Mathematics', 'french': 'French', 'history': 'History',
            'science': 'Science', 'geography': 'Geography'
          };

          currentSubject.innerHTML = `<i class="fas fa-book"></i> ${subjectNames[selectedMatiere] || selectedMatiere}`;

          // Mettre √† jour le placeholder
          if (textarea) {
            const placeholderText = "{% if lang == 'en' %}Ask your question about " + selectedMatiere + "...{% else %}Pose ta question sur " + (selectedMatiere === 'mathematics' ? 'math√©matiques' : selectedMatiere) + "...{% endif %}";
            textarea.placeholder = placeholderText;
          }
        });
      }

      // Scroll to bottom
      setTimeout(() => {
        const area = document.getElementById('messagesArea');
        if (area) area.scrollTop = area.scrollHeight;
      }, 100);

      // Validation simple du formulaire
      if (form) {
        form.addEventListener('submit', function(e) {
          if (!textarea || textarea.value.trim().length < 3) {
            e.preventDefault();
            alert("{% if lang == 'en' %}Please enter at least 3 characters{% else %}Veuillez entrer au moins 3 caract√®res{% endif %}");
            return false;
          }

          if (textarea.value.trim().length > 500) {
            e.preventDefault();
            alert("{% if lang == 'en' %}Maximum 500 characters{% else %}Maximum 500 caract√®res{% endif %}");
            return false;
          }

          // D√©sactiver le bouton pendant l'envoi
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
          }

          console.log('üì§ Formulaire soumis avec la mati√®re:', matiereInput ? matiereInput.value : 'non d√©finie');
        });
      }

      // Mettre √† jour l'heure
      function updateTime() {
        const now = new Date();
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
      }
      updateTime();
      setInterval(updateTime, 60000);

      // MathJax
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    });

    // Forcer le rechargement si page vient du cache
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        window.location.reload();
      }
    });
  </script>
</body>
</html>
