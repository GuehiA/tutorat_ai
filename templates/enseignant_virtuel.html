<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}</title>

  <!-- Cache control STRICT -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Bootstrap for alerts only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [['\\[', '\\]']]
      },
      startup: {
        pageReady: () => MathJax.startup.defaultPageReady()
      }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --success: #3fba83;
      --warning: #fcc419;
      --danger: #e85959;
      --light: #f8f9ff;
      --dark: #121826;
      --accent: #9b59b6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
      margin: 0;
      padding: 15px;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      height: 100%;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .niveau-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Contr√¥les d'accessibilit√© */
    .accessibility-controls {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-left: 4px solid var(--accent);
    }

    .accessibility-title {
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .accessibility-title i {
      color: var(--accent);
    }

    .accessibility-options {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-speech {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      background: var(--light);
      color: var(--dark);
      border: 1px solid #dee2e6;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .btn-speech:hover:not(:disabled) {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .btn-speech:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-speech.playing {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      animation: pulse 1.5s infinite;
    }

    .voice-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .voice-speed {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--dark);
    }

    .voice-speed select {
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      background: white;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* Bouton retour */
    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-3px);
    }

    /* S√©lecteur de mati√®re */
    .matiere-selector {
      margin-bottom: 15px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .matiere-selector label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .matiere-selector select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .matiere-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .controls form {
      margin: 0;
      flex: 1;
      display: flex;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      width: 100%;
      font-weight: 500;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-new {
      background: var(--success);
      color: white;
    }

    .btn-new:hover {
      background: #38a873;
    }

    /* Chat Container */
    .chat-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      height: calc(100vh - 270px);
      min-height: 500px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .messages-area::-webkit-scrollbar {
      width: 6px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    /* Messages */
    .message {
      margin-bottom: 15px;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      margin-left: auto;
    }

    .bot-message {
      margin-right: auto;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 15px;
      line-height: 1.4;
      position: relative;
    }

    .user-message .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .bot-message .message-bubble {
      background: #f0f2f5;
      color: var(--dark);
      border-bottom-left-radius: 5px;
      border-left: 3px solid var(--primary);
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    /* Bouton d'√©coute sur chaque message */
    .listen-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: var(--primary);
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.75rem;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .user-message .listen-btn {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .message-bubble:hover .listen-btn {
      opacity: 1;
    }

    .listen-btn:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .listen-btn.playing {
      background: var(--danger);
      color: white;
      opacity: 1;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Welcome message */
    .welcome-message .message-bubble {
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaff 100%);
      border-left: 4px solid var(--primary);
      padding: 20px;
    }

    .welcome-message h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .welcome-message ol {
      margin: 10px 0;
      padding-left: 20px;
    }

    .welcome-message li {
      margin-bottom: 8px;
    }

    /* Teacher's Last Question */
    .teacher-question {
      background: #fff9e6;
      border-left: 4px solid var(--warning);
      padding: 15px;
      margin: 15px 20px;
      border-radius: 8px;
      display: none;
    }

    .teacher-question h5 {
      margin: 0 0 8px 0;
      color: #e67e22;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Session info */
    .session-info {
      background: rgba(67, 97, 238, 0.1);
      border-radius: 8px;
      padding: 10px 15px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .session-matiere {
      background: var(--accent);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    /* Spinner */
    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Badge enseignant virtuel */
    .badge-enseignant {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* Mode dyslexie */
    .dyslexia-mode {
      font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
      letter-spacing: 0.05em;
      line-height: 1.8;
    }

    /* High contrast */
    .high-contrast-mode {
      background: #000 !important;
      color: #fff !important;
    }

    .high-contrast-mode .message-bubble {
      background: #222 !important;
      color: #fff !important;
      border: 1px solid #444 !important;
    }

    .high-contrast-mode .user-message .message-bubble {
      background: #1a5fb4 !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 12px 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .header-left {
        width: 100%;
        justify-content: space-between;
      }

      .niveau-badge {
        align-self: flex-start;
        margin-top: 5px;
      }

      .btn-back span {
        display: none;
      }

      .btn-back {
        padding: 8px 12px;
      }

      .accessibility-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .accessibility-options {
        width: 100%;
        justify-content: flex-start;
      }

      .controls {
        flex-direction: column;
      }

      .chat-container {
        height: calc(100vh - 290px);
      }

      .message {
        max-width: 90%;
      }

      .matiere-selector {
        padding: 12px;
      }

      .listen-btn {
        opacity: 1; /* Toujours visible sur mobile */
      }
    }

    @media (max-width: 480px) {
      .accessibility-options {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .voice-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="student-info">
          <div class="avatar">
            {{ eleve.nom_complet.split(' ')[0][0] }}
            {{ eleve.nom_complet.split(' ')[1][0] if eleve.nom_complet.split(' ')|length > 1 else '' }}
          </div>
          <div>
            <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-robot"></i>
              {% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}
              <span class="badge-enseignant">
                <i class="fas fa-bolt"></i>
                {% if lang == 'en' %}24/7{% else %}24h/24{% endif %}
              </span>
            </h3>
            <p style="margin: 3px 0 0 0; opacity: 0.9; font-size: 0.85rem;">
              {{ eleve.nom_complet.split(' ')[0] }}
            </p>
          </div>
        </div>

        <!-- Bouton de retour au dashboard -->
        <a href="{{ url_for('dashboard_eleve') }}" class="btn-back">
          <i class="fas fa-arrow-left"></i>
          <span>{% if lang == 'en' %}Dashboard{% else %}Retour{% endif %}</span>
        </a>
      </div>

      <div class="niveau-badge">
        <i class="fas fa-graduation-cap"></i>
        {{ eleve.niveau.nom if eleve.niveau else ('6th grade' if lang == 'en' else '6√®me') }}
      </div>
    </header>

    <!-- Information de session -->
    <div class="session-info">
      <div>
        <i class="fas fa-clock" style="margin-right: 5px; color: var(--primary);"></i>
        <span id="currentTime">{{ date_du_jour.strftime('%H:%M') if date_du_jour else '' }}</span>
      </div>
      <div class="session-matiere" id="currentSubject">
        <i class="fas fa-book"></i>
        {{ matiere|default('math√©matiques' if lang == 'fr' else 'mathematics')|title }}
      </div>
    </div>

    <!-- Contr√¥les d'accessibilit√© -->
    <div class="accessibility-controls">
      <div class="accessibility-title">
        <i class="fas fa-universal-access"></i>
        {% if lang == 'en' %}Accessibility Options{% else %}Options d'accessibilit√©{% endif %}
      </div>
      <div class="accessibility-options">
        <div class="voice-controls">
          <button id="readLastBtn" class="btn-speech">
            <i class="fas fa-volume-up"></i>
            {% if lang == 'en' %}Read Last{% else %}Lire le dernier{% endif %}
          </button>
          <button id="readAllBtn" class="btn-speech">
            <i class="fas fa-headphones"></i>
            {% if lang == 'en' %}Read All{% else %}Tout lire{% endif %}
          </button>
          <button id="stopSpeechBtn" class="btn-speech" disabled>
            <i class="fas fa-stop"></i>
            {% if lang == 'en' %}Stop{% else %}Arr√™ter{% endif %}
          </button>
          <div class="voice-speed">
            <span>{% if lang == 'en' %}Speed:{% else %}Vitesse:{% endif %}</span>
            <select id="voiceSpeed">
              <option value="0.7">0.7x</option>
              <option value="0.85">0.85x</option>
              <option value="1" selected>1x</option>
              <option value="1.15">1.15x</option>
              <option value="1.3">1.3x</option>
            </select>
          </div>
        </div>
        <button id="toggleDyslexia" class="btn-speech">
          <i class="fas fa-font"></i>
          {% if lang == 'en' %}Dyslexia{% else %}Dyslexie{% endif %}
        </button>
        <button id="toggleContrast" class="btn-speech">
          <i class="fas fa-adjust"></i>
          {% if lang == 'en' %}Contrast{% else %}Contraste{% endif %}
        </button>
      </div>
    </div>

    <!-- S√©lecteur de mati√®re -->
    <div class="matiere-selector">
      <label for="matiere">
        <i class="fas fa-book-open"></i>
        {% if lang == 'en' %}Select Subject:{% else %}Choisir la mati√®re :{% endif %}
      </label>
      <select name="matiere" id="matiereSelect">
        {% if lang == 'fr' %}
          <option value="math√©matiques" {% if matiere == 'math√©matiques' %}selected{% endif %}>Math√©matiques</option>
          <option value="fran√ßais" {% if matiere == 'fran√ßais' %}selected{% endif %}>Fran√ßais</option>
          <option value="histoire" {% if matiere == 'histoire' %}selected{% endif %}>Histoire</option>
          <option value="sciences" {% if matiere == 'sciences' %}selected{% endif %}>Sciences</option>
          <option value="g√©ographie" {% if matiere == 'g√©ographie' %}selected{% endif %}>G√©ographie</option>
        {% else %}
          <option value="mathematics" {% if matiere == 'mathematics' %}selected{% endif %}>Mathematics</option>
          <option value="french" {% if matiere == 'french' %}selected{% endif %}>French</option>
          <option value="history" {% if matiere == 'history' %}selected{% endif %}>History</option>
          <option value="science" {% if matiere == 'science' %}selected{% endif %}>Science</option>
          <option value="geography" {% if matiere == 'geography' %}selected{% endif %}>Geography</option>
        {% endif %}
      </select>
    </div>

    <!-- Controls -->
    <div class="controls">
      <form method="POST" action="/nouvel-exercice" id="newExerciseForm">
        <button type="submit" class="btn btn-new" id="newExerciseBtn">
          <i class="fas fa-plus-circle"></i>
          {% if lang == 'en' %}New Conversation{% else %}Nouvelle Conversation{% endif %}
        </button>
      </form>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Messages Area -->
      <div class="messages-area" id="messagesArea">
        <!-- Conversation avec donn√©es de synth√®se vocale -->
        {% if conversation_parlee and conversation_parlee|length > 0 %}
          {% for msg in conversation_parlee %}
            {% if msg.type == 'student' %}
              <div class="message user-message">
                <div class="message-header">
                  <i class="fas fa-user"></i>
                  <span>{% if lang == 'en' %}You{% else %}Toi{% endif %}</span>
                </div>
                <div class="message-bubble" data-spoken="{{ msg.spoken_content|escape }}">
                  {{ msg.content|safe }}
                  <button class="listen-btn" title="{% if lang == 'en' %}Listen to this message{% else %}√âcouter ce message{% endif %}">
                    <i class="fas fa-volume-up"></i>
                  </button>
                </div>
              </div>
            {% elif msg.type == 'bot' %}
              <div class="message bot-message">
                <div class="message-header">
                  <i class="fas fa-robot"></i>
                  <span>{% if lang == 'en' %}Virtual Teacher{% else %}Enseignant Virtuel{% endif %}</span>
                </div>
                <div class="message-bubble" data-spoken="{{ msg.spoken_content|escape }}">
                  {{ msg.content|safe }}
                  <button class="listen-btn" title="{% if lang == 'en' %}Listen to this message{% else %}√âcouter ce message{% endif %}">
                    <i class="fas fa-volume-up"></i>
                  </button>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <!-- Welcome Message -->
          <div class="message bot-message welcome-message">
            <div class="message-bubble" data-spoken="{% if lang == 'en' %}Hello! I'm your virtual teacher. Ask me any question about any subject! I'll guide you step by step without giving you the answer directly. How to use: Select your subject above. Ask your question. I'll guide you with questions. Answer my questions. Together we'll find the solution! Ready to learn? Write your question below!{% else %}Bonjour ! Je suis ton enseignant virtuel. Pose-moi n'importe quelle question sur n'importe quelle mati√®re ! Je te guiderai pas √† pas sans te donner la r√©ponse directement. Comment utiliser : Choisis ta mati√®re ci-dessus. Pose ta question. Je te guiderai avec des questions. R√©ponds √† mes questions. Ensemble on trouvera la solution ! Pr√™t √† apprendre ? √âcris ta question ci-dessous !{% endif %}">
              <h4><i class="fas fa-graduation-cap"></i>
                {% if lang == 'en' %}Hello {{ eleve.nom_complet.split(' ')[0] }}!{% else %}Bonjour {{ eleve.nom_complet.split(' ')[0] }} !{% endif %}
              </h4>

              <p><strong>{% if lang == 'en' %}I'm your Virtual Teacher{% else %}Je suis ton Enseignant Virtuel{% endif %}</strong>
                {% if lang == 'en' %}üë®‚Äçüè´{% else %}üë©‚Äçüè´{% endif %}
              </p>

              <p>{% if lang == 'en' %}
                I'm here to help you understand concepts and solve problems in any subject!
                <strong>I won't give direct answers</strong>, but I'll guide you step by step so you discover the solutions yourself.
              {% else %}
                Je suis l√† pour t'aider √† comprendre les concepts et r√©soudre des probl√®mes dans toutes les mati√®res !
                <strong>Je ne donnerai pas les r√©ponses directement</strong>, mais je te guiderai pas √† pas pour que tu d√©couvres les solutions toi-m√™me.
              {% endif %}</p>

              <p><strong>{% if lang == 'en' %}How to use:{% else %}Comment utiliser :{% endif %}</strong></p>
              <ol>
                <li>{% if lang == 'en' %}Select your subject above{% else %}Choisis ta mati√®re ci-dessus{% endif %}</li>
                <li>{% if lang == 'en' %}Ask your question{% else %}Pose ta question{% endif %}</li>
                <li>{% if lang == 'en' %}I'll guide you with questions{% else %}Je te guiderai avec des questions{% endif %}</li>
                <li>{% if lang == 'en' %}Answer my questions{% else %}R√©ponds √† mes questions{% endif %}</li>
                <li>{% if lang == 'en' %}Together we'll find the solution!{% else %}Ensemble on trouvera la solution !{% endif %}</li>
              </ol>

              <p style="margin-top: 15px; padding: 10px; background: rgba(67, 97, 238, 0.1); border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #fcc419;"></i>
                <strong>{% if lang == 'en' %}Pro tip:{% else %}Astuce :{% endif %}</strong>
                {% if lang == 'en' %}
                  You can ask about homework, exam preparation, concept explanations, or practice exercises.
                {% else %}
                  Tu peux poser des questions sur tes devoirs, la pr√©paration d'examens, l'explication de concepts ou des exercices d'entra√Ænement.
                {% endif %}
              </p>

              <p style="text-align: center; margin-top: 20px;">
                <em>‚ú® {% if lang == 'en' %}Ready to learn? Write your question below!{% else %}Pr√™t √† apprendre ? √âcris ta question ci-dessous !{% endif %}</em>
              </p>
              <button class="listen-btn" title="{% if lang == 'en' %}Listen to welcome message{% else %}√âcouter le message de bienvenue{% endif %}">
                <i class="fas fa-volume-up"></i>
              </button>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Teacher's Last Question -->
      {% set derniere_q_ia = session.get('derniere_q_ia') %}
      {% if derniere_q_ia and conversation_parlee|length > 0 %}
      <div class="teacher-question" id="teacherQuestion" style="display: block;">
        <h5><i class="fas fa-question-circle"></i>
          {% if lang == 'en' %}My question for you:{% else %}Ma question pour toi :{% endif %}
        </h5>
        <p>{{ derniere_q_ia }}</p>
        <small style="color: #666; display: block; margin-top: 5px;">
          <i class="fas fa-hand-point-right"></i>
          {% if lang == 'en' %}Answer in the box below{% else %}R√©ponds dans la zone ci-dessous{% endif %}
        </small>
      </div>
      {% endif %}

      <!-- Input Area -->
      <div class="input-area">
        <form method="POST" action="{{ url_for('enseignant_virtuel') }}" id="mainForm">
          <!-- Champ cach√© pour la mati√®re -->
          <input type="hidden" name="matiere" id="matiereInput" value="{{ matiere|default('math√©matiques' if lang == 'fr' else 'mathematics') }}">

          <div class="input-group">
            <textarea
              name="question"
              id="questionInput"
              placeholder="{% if derniere_q_ia and conversation_parlee|length > 0 %}{% if lang == 'en' %}Answer the teacher's question...{% else %}R√©ponds √† la question de l'enseignant...{% endif %}{% else %}{% if lang == 'en' %}Ask your question about {{ matiere|default('mathematics') }}...{% else %}Pose ta question sur {{ matiere|default('math√©matiques') }}...{% endif %}{% endif %}"
              required
              autofocus
              rows="3"></textarea>

            <button type="submit" class="btn-send" id="submitBtn" title="{% if lang == 'en' %}Send message{% else %}Envoyer le message{% endif %}">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>

          <div style="display: flex; justify-content: space-between; margin-top: 8px;">
            <small style="color: #666; font-size: 0.85rem;">
              <i class="fas fa-keyboard"></i>
              {% if lang == 'en' %}Press Shift+Enter for new line{% else %}Shift+Entr√©e pour aller √† la ligne{% endif %}
            </small>
            <small id="charCount" style="color: #999; font-size: 0.85rem;">0/500</small>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS for alerts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JavaScript pour la synth√®se vocale -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üì± Enseignant Virtuel - Page charg√©e avec synth√®se vocale");

      // Variables pour la synth√®se vocale
      let speechSynthesis = window.speechSynthesis;
      let isSpeaking = false;
      let currentUtterance = null;
      let speechQueue = [];
      let currentLang = "{{ lang }}";
      
      // V√©rifier si la synth√®se vocale est support√©e
      const isSpeechSupported = 'speechSynthesis' in window;
      
      // √âl√©ments DOM
      const textarea = document.getElementById('questionInput');
      const submitBtn = document.getElementById('submitBtn');
      const matiereSelect = document.getElementById('matiereSelect');
      const matiereInput = document.getElementById('matiereInput');
      const currentSubject = document.getElementById('currentSubject');
      const charCount = document.getElementById('charCount');
      const form = document.getElementById('mainForm');
      const readLastBtn = document.getElementById('readLastBtn');
      const readAllBtn = document.getElementById('readAllBtn');
      const stopSpeechBtn = document.getElementById('stopSpeechBtn');
      const voiceSpeed = document.getElementById('voiceSpeed');
      const toggleDyslexiaBtn = document.getElementById('toggleDyslexia');
      const toggleContrastBtn = document.getElementById('toggleContrast');
      const listenButtons = document.querySelectorAll('.listen-btn');
      
      // D√©sactiver les boutons si pas support√©
      if (!isSpeechSupported) {
        console.warn('Synth√®se vocale non support√©e par le navigateur');
        readLastBtn.disabled = true;
        readAllBtn.disabled = true;
        readLastBtn.title = readAllBtn.title = currentLang === 'fr' 
          ? 'Synth√®se vocale non support√©e' 
          : 'Speech synthesis not supported';
        listenButtons.forEach(btn => btn.disabled = true);
      }
      
      // Initialisation de la synth√®se vocale
      function initSpeechSynthesis() {
        if (!isSpeechSupported) return false;
        
        // R√©cup√©rer les voix disponibles
        let voices = [];
        
        speechSynthesis.onvoiceschanged = function() {
          voices = speechSynthesis.getVoices();
          console.log('Voix disponibles:', voices.map(v => v.name));
        };
        
        // Forcer le chargement des voix
        setTimeout(() => {
          voices = speechSynthesis.getVoices();
          if (voices.length === 0) {
            console.warn('Aucune voix disponible');
          }
        }, 100);
        
        return true;
      }
      
      // Fonction pour lire du texte
      function speakText(text, callback = null) {
        if (!text || !isSpeechSupported) return;
        
        // Arr√™ter toute lecture en cours
        stopSpeaking();
        
        // Cr√©er l'√©nonc√©
        currentUtterance = new SpeechSynthesisUtterance(text);
        
        // Configurer la voix
        currentUtterance.lang = currentLang === 'fr' ? 'fr-FR' : 'en-GB';
        currentUtterance.rate = parseFloat(voiceSpeed.value);
        currentUtterance.volume = 1;
        currentUtterance.pitch = 1;
        
        // Choisir la voix appropri√©e
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => {
          if (currentLang === 'fr') {
            return voice.lang === 'fr-FR' || voice.lang === 'fr-fr' || voice.lang === 'fr';
          } else {
            return voice.lang === 'en-GB' || voice.lang === 'en-US' || voice.lang.startsWith('en');
          }
        }) || voices[0];
        
        if (preferredVoice) {
          currentUtterance.voice = preferredVoice;
        }
        
        // Gestion des √©v√©nements
        currentUtterance.onstart = function() {
          isSpeaking = true;
          stopSpeechBtn.disabled = false;
          readLastBtn.disabled = true;
          readAllBtn.disabled = true;
          document.querySelectorAll('.listen-btn').forEach(btn => btn.disabled = true);
        };
        
        currentUtterance.onend = function() {
          isSpeaking = false;
          stopSpeechBtn.disabled = true;
          readLastBtn.disabled = false;
          readAllBtn.disabled = false;
          document.querySelectorAll('.listen-btn').forEach(btn => btn.disabled = false);
          
          // R√©initialiser les boutons d'√©coute
          document.querySelectorAll('.listen-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
            btn.querySelector('i').className = 'fas fa-volume-up';
          });
          
          if (callback) callback();
          
          // Lire le prochain √©l√©ment dans la file d'attente
          if (speechQueue.length > 0) {
            const nextText = speechQueue.shift();
            speakText(nextText);
          }
        };
        
        currentUtterance.onerror = function(event) {
          console.error('Erreur de synth√®se vocale:', event);
          isSpeaking = false;
          stopSpeechBtn.disabled = true;
          readLastBtn.disabled = false;
          readAllBtn.disabled = false;
          document.querySelectorAll('.listen-btn').forEach(btn => btn.disabled = false);
          
          document.querySelectorAll('.listen-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
            btn.querySelector('i').className = 'fas fa-volume-up';
          });
          
          // Afficher une alerte silencieuse
          if (currentLang === 'fr') {
            console.warn('Impossible de lire le texte. V√©rifiez que votre navigateur supporte la synth√®se vocale.');
          } else {
            console.warn('Unable to read text. Please check if your browser supports speech synthesis.');
          }
        };
        
        // Lire le texte
        try {
          speechSynthesis.speak(currentUtterance);
        } catch (error) {
          console.error('Erreur lors de la lecture:', error);
        }
      }
      
      // Fonction pour arr√™ter la lecture
      function stopSpeaking() {
        if (speechSynthesis && speechSynthesis.speaking) {
          speechSynthesis.cancel();
          isSpeaking = false;
          stopSpeechBtn.disabled = true;
          readLastBtn.disabled = false;
          readAllBtn.disabled = false;
          speechQueue = [];
          document.querySelectorAll('.listen-btn').forEach(btn => btn.disabled = false);
          
          document.querySelectorAll('.listen-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
            btn.querySelector('i').className = 'fas fa-volume-up';
          });
        }
      }
      
      // Lire le dernier message
      function readLastMessage() {
        const lastMessage = document.querySelector('.message:last-child .message-bubble');
        if (lastMessage) {
          const text = lastMessage.getAttribute('data-spoken');
          if (text) {
            speakText(text);
            
            // Mettre en √©vidence le bouton du dernier message
            const listenBtn = lastMessage.querySelector('.listen-btn');
            if (listenBtn) {
              listenBtn.classList.add('playing');
              listenBtn.querySelector('i').className = 'fas fa-stop';
            }
          }
        }
      }
      
      // Lire toute la conversation
      function readAllMessages() {
        const messages = document.querySelectorAll('.message-bubble');
        if (messages.length === 0) return;
        
        // Vider la file d'attente
        speechQueue = [];
        
        // Ajouter tous les messages √† la file d'attente
        messages.forEach((message, index) => {
          const text = message.getAttribute('data-spoken');
          if (text && text.trim().length > 0) {
            speechQueue.push(text);
          }
        });
        
        // Lire le premier message
        if (speechQueue.length > 0) {
          const firstText = speechQueue.shift();
          speakText(firstText);
          
          // Mettre en √©vidence le premier bouton
          const firstListenBtn = messages[0].querySelector('.listen-btn');
          if (firstListenBtn) {
            firstListenBtn.classList.add('playing');
            firstListenBtn.querySelector('i').className = 'fas fa-stop';
          }
        }
      }
      
      // Gestionnaires d'√©v√©nements pour la synth√®se vocale
      readLastBtn.addEventListener('click', readLastMessage);
      readAllBtn.addEventListener('click', readAllMessages);
      stopSpeechBtn.addEventListener('click', stopSpeaking);
      
      voiceSpeed.addEventListener('change', function() {
        if (isSpeaking && currentUtterance) {
          currentUtterance.rate = parseFloat(this.value);
          speechSynthesis.cancel();
          speechSynthesis.speak(currentUtterance);
        }
      });
      
      // Gestion des boutons d'√©coute individuels
      listenButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.stopPropagation();
          
          const messageBubble = this.closest('.message-bubble');
          if (!messageBubble) return;
          
          const text = messageBubble.getAttribute('data-spoken');
          if (!text) return;
          
          if (isSpeaking && this.classList.contains('playing')) {
            // Si d√©j√† en train de lire ce message, arr√™ter
            stopSpeaking();
          } else {
            // Sinon, lire ce message
            stopSpeaking();
            
            // Mettre en √©vidence ce bouton
            document.querySelectorAll('.listen-btn.playing').forEach(btn => {
              btn.classList.remove('playing');
              btn.querySelector('i').className = 'fas fa-volume-up';
            });
            
            this.classList.add('playing');
            this.querySelector('i').className = 'fas fa-stop';
            speakText(text);
          }
        });
      });
      
      // Mode dyslexie
      toggleDyslexiaBtn.addEventListener('click', function() {
        document.body.classList.toggle('dyslexia-mode');
        this.classList.toggle('active');
        this.innerHTML = this.classList.contains('active')
          ? '<i class="fas fa-font"></i>' + (currentLang === 'fr' ? ' Standard' : ' Standard')
          : '<i class="fas fa-font"></i>' + (currentLang === 'fr' ? ' Dyslexie' : ' Dyslexia');
      });
      
      // Mode haut contraste
      toggleContrastBtn.addEventListener('click', function() {
        document.body.classList.toggle('high-contrast-mode');
        this.classList.toggle('active');
        this.innerHTML = this.classList.contains('active')
          ? '<i class="fas fa-adjust"></i>' + (currentLang === 'fr' ? ' Normal' : ' Normal')
          : '<i class="fas fa-adjust"></i>' + (currentLang === 'fr' ? ' Contraste' : ' Contrast');
      });
      
      // Initialiser la synth√®se vocale
      initSpeechSynthesis();
      
      // Fonctionnalit√©s existantes
      if (textarea) {
        textarea.focus();

        // Compteur de caract√®res
        textarea.addEventListener('input', function() {
          const length = this.value.length;
          if (charCount) {
            charCount.textContent = `${length}/500`;
            charCount.style.color = length > 450 ? '#e85959' : length > 300 ? '#fcc419' : '#999';
          }
        });

        // Initialiser le compteur
        if (charCount) {
          charCount.textContent = `${textarea.value.length}/500`;
        }
      }

      // S√©lecteur de mati√®re
      if (matiereSelect && matiereInput && currentSubject) {
        matiereSelect.addEventListener('change', function() {
          const selectedMatiere = this.value;
          matiereInput.value = selectedMatiere;

          // Mettre √† jour l'affichage
          const subjectNames = {
            'math√©matiques': 'Math√©matiques', 'fran√ßais': 'Fran√ßais', 'histoire': 'Histoire',
            'sciences': 'Sciences', 'g√©ographie': 'G√©ographie',
            'mathematics': 'Mathematics', 'french': 'French', 'history': 'History',
            'science': 'Science', 'geography': 'Geography'
          };

          currentSubject.innerHTML = `<i class="fas fa-book"></i> ${subjectNames[selectedMatiere] || selectedMatiere}`;

          // Mettre √† jour le placeholder
          if (textarea) {
            const placeholderText = currentLang === 'en' 
              ? `Ask your question about ${selectedMatiere}...`
              : `Pose ta question sur ${selectedMatiere === 'mathematics' ? 'math√©matiques' : selectedMatiere}...`;
            textarea.placeholder = placeholderText;
          }
        });
      }

      // Scroll to bottom
      setTimeout(() => {
        const area = document.getElementById('messagesArea');
        if (area) area.scrollTop = area.scrollHeight;
      }, 100);

      // Validation simple du formulaire
      if (form) {
        form.addEventListener('submit', function(e) {
          if (!textarea || textarea.value.trim().length < 3) {
            e.preventDefault();
            alert(currentLang === 'en' 
              ? "Please enter at least 3 characters" 
              : "Veuillez entrer au moins 3 caract√®res");
            return false;
          }

          if (textarea.value.trim().length > 500) {
            e.preventDefault();
            alert(currentLang === 'en' 
              ? "Maximum 500 characters" 
              : "Maximum 500 caract√®res");
            return false;
          }

          // D√©sactiver le bouton pendant l'envoi
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
          }

          console.log('üì§ Formulaire soumis avec la mati√®re:', matiereInput ? matiereInput.value : 'non d√©finie');
        });
      }

      // Mettre √† jour l'heure
      function updateTime() {
        const now = new Date();
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
          timeElement.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
      }
      updateTime();
      setInterval(updateTime, 60000);

      // MathJax
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
      
      // Forcer le rechargement si page vient du cache
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
          window.location.reload();
        }
      });
    });
  </script>
</body>
</html>